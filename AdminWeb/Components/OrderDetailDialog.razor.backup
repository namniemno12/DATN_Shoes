@using DAL.DTOs.Orders.Res
@inject AdminWeb.Services.ToastService Toast
@inject AdminWeb.Services.ShippingService ShippingService
@inject IJSRuntime JS

@if (Show && Order != null)
{
    <div class="modal-overlay @(Show ? "show" : "")" @onclick="HandleOverlayClick">
        <div class="modal-dialog" @onclick:stopPropagation @ref="modalElement" tabindex="-1">
            <div class="modal-header">
                <div class="header-info">
                    <h2 class="modal-title">Chi tiết đơn hàng</h2>
                    <span class="order-code-badge">@Order.OrderCode</span>
                </div>
                <button class="btn-close" @onclick="HandleClose">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                        <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <!-- Order Timeline -->
                <div class="detail-section timeline-section">
                    <h3 class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/>
                        </svg>
                        Lịch sử đơn hàng
                    </h3>
                    <div class="timeline">
                        @foreach (var history in Order.StatusHistory.OrderByDescending(h => h.ChangedAt))
                        {
                            <div class="timeline-item @(history.Status == Order.Status ? "active" : "")">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <span class="timeline-status">@history.StatusText</span>
                                        <span class="timeline-date">@history.ChangedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(history.Note))
                                    {
                                        <p class="timeline-note">@history.Note</p>
                                    }
                                    <span class="timeline-user">Bởi: @history.UpdatedBy</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="content-grid">
                    <!-- Left Column -->
                    <div class="left-column">
                        <!-- Customer Info -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                    <path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/>
                                </svg>
                                Thông tin khách hàng
                            </h3>
                            <div class="info-card">
                                <div class="customer-avatar-large">@Order.Customer.FullName.Substring(0, 1).ToUpper()</div>
                                <div class="info-rows">
                                    <div class="info-row">
                                        <span class="info-label">Họ tên:</span>
                                        <span class="info-value">@Order.Customer.FullName</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Email:</span>
                                        <span class="info-value">@Order.Customer.Email</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Điện thoại:</span>
                                        <span class="info-value">@Order.Customer.Phone</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Username:</span>
                                        <span class="info-value">@Order.Customer.Username</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Info -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                    <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                                </svg>
                                Địa chỉ giao hàng
                            </h3>
                            <div class="info-card">
                                <div class="info-rows">
                                    <div class="info-row">
                                        <span class="info-label">Người nhận:</span>
                                        <span class="info-value">@Order.ShippingInfo.ReceiverName</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Số điện thoại:</span>
                                        <span class="info-value">@Order.ShippingInfo.ReceiverPhone</span>
                                    </div>
                                    <div class="info-row full-width">
                                        <span class="info-label">Địa chỉ:</span>
                                        <span class="info-value">@Order.ShippingInfo.FullAddress</span>
                                    </div>
                                    @if (!string.IsNullOrEmpty(Order.ShippingInfo.Note))
                                    {
                                        <div class="info-row full-width">
                                            <span class="info-label">Ghi chú:</span>
                                            <span class="info-value note">@Order.ShippingInfo.Note</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Payment & Shipment Info -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                    <path d="M64 64C28.7 64 0 92.7 0 128v64c0 8.8 7.4 15.7 15.7 18.6C34.5 217.1 48 235 48 256s-13.5 38.9-32.3 45.4C7.4 304.3 0 311.2 0 320v64c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V320c0-8.8-7.4-15.7-15.7-18.6C541.5 294.9 528 277 528 256s13.5-38.9 32.3-45.4c8.3-2.9 15.7-9.8 15.7-18.6V128c0-35.3-28.7-64-64-64H64zm64 112l0 160c0 8.8 7.2 16 16 16H432c8.8 0 16-7.2 16-16V176c0-8.8-7.2-16-16-16H144c-8.8 0-16 7.2-16 16zM96 160c0-17.7 14.3-32 32-32H448c17.7 0 32 14.3 32 32V352c0 17.7-14.3 32-32 32H128c-17.7 0-32-14.3-32-32V160z"/>
                                </svg>
                                Thanh toán & Vận chuyển
                            </h3>
                            <div class="info-card">
                                <div class="info-rows">
                                    <div class="info-row">
                                        <span class="info-label">Phương thức TT:</span>
                                        <span class="info-value badge badge-payment">@Order.Payment.PaymentMethodText</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Trạng thái TT:</span>
                                        <span class="info-value badge @GetPaymentStatusClass(Order.Payment.PaymentStatus)">
                                            @Order.Payment.PaymentStatusText
                                        </span>
                                    </div>
                                    @if (Order.Payment.PaidAt.HasValue)
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Thanh toán lúc:</span>
                                            <span class="info-value">@Order.Payment.PaidAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(Order.Shipment.ShippingProvider))
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Đơn vị vận chuyển:</span>
                                            <span class="info-value">@Order.Shipment.ShippingProvider</span>
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(Order.Shipment.TrackingNumber))
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Mã vận đơn:</span>
                                            <span class="info-value tracking">@Order.Shipment.TrackingNumber</span>
                                        </div>
                                    }
                                    @if (Order.Shipment.EstimatedDelivery.HasValue)
                                    {
                                        <div class="info-row">
                                            <span class="info-label">Dự kiến giao:</span>
                                            <span class="info-value">@Order.Shipment.EstimatedDelivery.Value.ToString("dd/MM/yyyy")</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- GHN Shipping Info - Enhanced -->
                        @if (Order.Shipment != null)
                        {
                            <div class="detail-section ghn-section">
                                <h3 class="section-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="currentColor">
                                        <path d="M112 0C85.5 0 64 21.5 64 48V96H16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 272c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 48c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 240c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 208c8.8 0 16 7.2 16 16s-7.2 16-16 16H64V416c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H112zM544 237.3V256H416V160h50.7L544 237.3zM160 464a48 48 0 1 1 0-96 48 48 0 1 1 0 96zm368-48a48 48 0 1 1 -96 0 48 48 0 1 1 96 0z"/>
                                    </svg>
                                    <span class="ghn-logo">Giao Hàng Nhanh</span>
                                    @if (!string.IsNullOrEmpty(Order.Shipment.GhnOrderCode))
                                    {
                                        <span class="badge @GetGhnStatusClass(Order.Shipment.GhnStatus)" style="margin-left: auto;">
                                            @GetGhnStatusText(Order.Shipment.GhnStatus)
                                        </span>
                                    }
                                </h3>
                                <div class="info-card ghn-card">
                                    @if (string.IsNullOrEmpty(Order.Shipment.GhnOrderCode))
                                    {
                                        <!-- Chưa gửi GHN -->
                                        <div class="ghn-empty">
                                            <div class="ghn-empty-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                                    <path d="M173.8 5.5c11-7.3 25.4-7.3 36.4 0L228 17.2c6 3.9 13 5.8 20.1 5.4l21.3-1.3c13.2-.8 25.6 6.4 31.5 18.2l9.6 19.1c3.2 6.4 8.4 11.5 14.7 14.7L344.5 83c11.8 5.9 19 18.3 18.2 31.5l-1.3 21.3c-.4 7.1 1.5 14.2 5.4 20.1l11.8 17.8c7.3 11 7.3 25.4 0 36.4L366.8 228c-3.9 6-5.8 13-5.4 20.1l1.3 21.3c.8 13.2-6.4 25.6-18.2 31.5l-19.1 9.6c-6.4 3.2-11.5 8.4-14.7 14.7L301 344.5c-5.9 11.8-18.3 19-31.5 18.2l-21.3-1.3c-7.1-.4-14.2 1.5-20.1 5.4l-17.8 11.8c-11 7.3-25.4 7.3-36.4 0L156 366.8c-6-3.9-13-5.8-20.1-5.4l-21.3 1.3c-13.2 .8-25.6-6.4-31.5-18.2l-9.6-19.1c-3.2-6.4-8.4-11.5-14.7-14.7L39.5 301c-11.8-5.9-19-18.3-18.2-31.5l1.3-21.3c.4-7.1-1.5-14.2-5.4-20.1L5.5 210.2c-7.3-11-7.3-25.4 0-36.4L17.2 156c3.9-6 5.8-13 5.4-20.1l-1.3-21.3c-.8-13.2 6.4-25.6 18.2-31.5l19.1-9.6C65 70.2 70.2 65 73.4 58.6L83 39.5c5.9-11.8 18.3-19 31.5-18.2l21.3 1.3c7.1 .4 14.2-1.5 20.1-5.4L173.8 5.5zM272 192a80 80 0 1 0 -160 0 80 80 0 1 0 160 0zM1.3 441.8L44.4 339.3c.2 .1 .3 .2 .4 .4l9.6 19.1c11.7 23.2 36 37.3 62 35.8l21.3-1.3c.2 0 .5 0 .7 .2l17.8 11.8c5.1 3.3 10.5 5.9 16.1 7.7l-37.6 89.3c-2.3 5.5-7.4 9.2-13.3 9.7s-11.6-2.2-14.8-7.2L74.4 455.5l-56.1 8.3c-5.7 .8-11.4-1.5-15-6s-4.3-10.7-2.1-16zm248 60.4L211.7 413c5.6-1.8 11-4.3 16.1-7.7l17.8-11.8c.2-.1 .4-.2 .7-.2l21.3 1.3c26 1.5 50.3-12.6 62-35.8l9.6-19.1c.1-.2 .2-.3 .4-.4l43.2 102.5c2.2 5.3 1.4 11.4-2.1 16s-9.3 6.9-15 6l-56.1-8.3-32.2 49.2c-3.2 5-8.9 7.7-14.8 7.2s-11-4.3-13.3-9.7z"/>
                                                </svg>
                                            </div>
                                            <p class="ghn-empty-text">Đơn hàng chưa được gửi lên GHN</p>
                                            <p class="ghn-empty-note">Xác nhận đơn hàng để gửi lên hệ thống GHN</p>
                                            <button class="btn btn-ghn" @onclick="HandleSendToGhn" disabled="@isSendingToGhn">
                                                @if (isSendingToGhn)
                                                {
                                                    <span class="spinner-small"></span>
                                                    <span>Đang gửi...</span>
                                                }
                                                else
                                                {
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                        <path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/>
                                                    </svg>
                                                    <span>Gửi đơn lên GHN</span>
                                                }
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <!-- Đã gửi GHN - Enhanced Display -->
                                        <div class="ghn-info-grid">
                                            <!-- Mã đơn GHN -->
                                            <div class="ghn-info-highlight">
                                                <div class="ghn-info-icon">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                                        <path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"/>
                                                    </svg>
                                                </div>
                                                <div class="ghn-info-content">
                                                    <span class="ghn-info-label">Mã đơn GHN</span>
                                                    <span class="ghn-info-value ghn-order-code">@Order.Shipment.GhnOrderCode</span>
                                                    <button class="btn-copy" @onclick="@(() => CopyToClipboard(Order.Shipment.GhnOrderCode))" title="Sao chép">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                                            <path d="M384 336H192c-8.8 0-16-7.2-16-16V64c0-8.8 7.2-16 16-16l140.1 0L400 115.9V320c0 8.8-7.2 16-16 16zM192 384H384c35.3 0 64-28.7 64-64V115.9c0-12.7-5.1-24.9-14.1-33.9L366.1 14.1c-9-9-21.2-14.1-33.9-14.1H192c-35.3 0-64 28.7-64 64V320c0 35.3 28.7 64 64 64zM64 128c-35.3 0-64 28.7-64 64V448c0 35.3 28.7 64 64 64H256c35.3 0 64-28.7 64-64V416H272v32c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192c0-8.8 7.2-16 16-16H96V128H64z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Các thông tin khác -->
                                            <div class="info-rows ghn-details">
                                                @if (Order.Shipment.GhnFee.HasValue)
                                                {
                                                    <div class="info-row">
                                                        <span class="info-label">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                                                <path d="M312 24V34.5c6.4 1.2 12.6 2.7 18.2 4.2c12.8 3.4 20.4 16.6 17 29.4s-16.6 20.4-29.4 17c-10.9-2.9-21.1-4.9-30.2-5c-7.3-.1-14.7 1.7-19.4 4.4c-2.1 1.3-3.1 2.4-3.5 3c-.3 .5-.7 1.2-.7 2.8c0 .3 0 .5 0 .6c.2 .2 .9 1.2 3.3 2.6c5.8 3.5 14.4 6.2 27.4 10.1l.9 .3c11.1 3.3 25.9 7.8 37.9 15.3c13.7 8.6 26.1 22.9 26.4 44.9c.3 22.5-11.4 38.9-26.7 48.5c-6.7 4.1-13.9 7-21.3 8.8V232c0 13.3-10.7 24-24 24s-24-10.7-24-24V220.6c-9.5-2.3-18.2-5.3-25.6-7.8c-2.1-.7-4.1-1.4-6-2c-12.6-4.2-19.4-17.8-15.2-30.4s17.8-19.4 30.4-15.2c2.6 .9 5 1.7 7.3 2.5c13.6 4.6 23.4 7.9 33.9 8.3c8 .3 15.1-1.6 19.2-4.1c1.9-1.2 2.8-2.2 3.2-2.9c.4-.6 .9-1.8 .8-4.1l0-.2c0-1 0-2.1-4-4.6c-5.7-3.6-14.3-6.4-27.1-10.3l-1.9-.6c-10.8-3.2-25-7.5-36.4-14.4c-13.5-8.1-26.5-22-26.6-44.1c-.1-22.9 12.9-38.6 27.7-47.4c6.4-3.8 13.3-6.4 20.2-8.2V24c0-13.3 10.7-24 24-24s24 10.7 24 24zM568.2 336.3c13.1 17.8 9.3 42.8-8.5 55.9L433.1 485.5c-23.4 17.2-51.6 26.5-80.7 26.5H192 32c-17.7 0-32-14.3-32-32V416c0-17.7 14.3-32 32-32H68.8l44.9-36c22.7-18.2 50.9-28 80-28H272h16 64c17.7 0 32 14.3 32 32s-14.3 32-32 32H288 272c-8.8 0-16 7.2-16 16s7.2 16 16 16H392.6l119.7-88.2c17.8-13.1 42.8-9.3 55.9 8.5zM193.6 384l0 0-.9 0c.3 0 .6 0 .9 0z"/>
                                                            </svg>
                                                            Phí vận chuyển
                                                        </span>
                                                        <span class="info-value ghn-fee">@Order.Shipment.GhnFee.Value.ToString("N0")₫</span>
                                                    </div>
                                                }
                                                
                                                <div class="info-row">
                                                    <span class="info-label">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                                            <path d="M64 64C28.7 64 0 92.7 0 128V384c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V128c0-35.3-28.7-64-64-64H64zm48 160H272c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16s7.2-16 16-16zM96 336c0-8.8 7.2-16 16-16H464c8.8 0 16 7.2 16 16s-7.2 16-16 16H112c-8.8 0-16-7.2-16-16zM376 160h80c13.3 0 24 10.7 24 24v48c0 13.3-10.7 24-24 24H376c-13.3 0-24-10.7-24-24V184c0-13.3 10.7-24 24-24z"/>
                                                        </svg>
                                                        Thu COD
                                                    </span>
                                                    <span class="info-value">
                                                        <span class="badge @(Order.Shipment.CodCollected ? "badge-success" : "badge-warning")">
                                                            @if (Order.Shipment.CodCollected)
                                                            {
                                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                                                    <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
                                                                </svg>
                                                                <span>Đã thu</span>
                                                            }
                                                            else
                                                            {
                                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM232 344V280H168c-13.3 0-24-10.7-24-24s10.7-24 24-24h64V168c0-13.3 10.7-24 24-24s24 10.7 24 24v64h64c13.3 0 24 10.7 24 24s-10.7 24-24 24H280v64c0 13.3-10.7 24-24 24s-24-10.7-24-24z"/>
                                                                </svg>
                                                                <span>Chưa thu</span>
                                                            }
                                                        </span>
                                                    </span>
                                                </div>

                                                @if (!string.IsNullOrEmpty(Order.ShippingInfo.FullAddress))
                                                {
                                                    <div class="info-row full-width">
                                                        <span class="info-label">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                                                <path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/>
                                                            </svg>
                                                            Địa chỉ giao hàng
                                                        </span>
                                                        <span class="info-value">@Order.ShippingInfo.FullAddress</span>
                                                    </div>
                                                }

                                                <div class="info-row ghn-timestamps">
                                                    @if (Order.Shipment.GhnCreatedAt.HasValue)
                                                    {
                                                        <div class="timestamp-item">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                                <path d="M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/>
                                                            </svg>
                                                            <div>
                                                                <span class="timestamp-label">Tạo đơn</span>
                                                                <span class="timestamp-value">@Order.Shipment.GhnCreatedAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                            </div>
                                                        </div>
                                                    }
                                                    @if (Order.Shipment.GhnUpdatedAt.HasValue)
                                                    {
                                                        <div class="timestamp-item">
                                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                                <path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75z"/>
                                                            </svg>
                                                            <div>
                                                                <span class="timestamp-label">Cập nhật</span>
                                                                <span class="timestamp-value">@Order.Shipment.GhnUpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>

                                            <!-- Action Buttons -->
                                            <div class="ghn-actions">
                                                <button class="btn btn-secondary" @onclick="HandleRefreshGhnStatus" disabled="@isRefreshingGhn">
                                                    @if (isRefreshingGhn)
                                                    {
                                                        <span class="spinner-small"></span>
                                                    }
                                                    else
                                                    {
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                            <path d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H336c-17.7 0-32 14.3-32 32s14.3 32 32 32H463.5c0 0 0 0 0 0h.4c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v51.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5z"/>
                                                        </svg>
                                                    }
                                                    <span>Làm mới</span>
                                                </button>
                                                <a href="https://donhang.ghn.vn/?order_code=@Order.Shipment.GhnOrderCode" 
                                                   target="_blank" 
                                                   class="btn btn-link">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                                        <path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32H320zM80 32C35.8 32 0 67.8 0 112V432c0 44.2 35.8 80 80 80H400c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32V432c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16H192c17.7 0 32-14.3 32-32s-14.3-32-32-32H80z"/>
                                                    </svg>
                                                    <span>Xem trên GHN</span>
                                                </a>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Right Column -->
                    <div class="right-column">
                        <!-- Order Items -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                    <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22.1 0 41.5 15.2 46.4 36.7L128 64H544c17.7 0 32 14.3 32 32c0 3.4-.5 6.7-1.4 9.8l-63.1 216.9c-8.5 29.2-35.4 49.3-65.7 49.3H192c-30.3 0-57.2-20.1-65.7-49.3L44.2 80H24C10.7 80 0 69.3 0 56V24z"/>
                                </svg>
                                Sản phẩm (@Order.Items.Count)
                            </h3>
                            <div class="product-list">
                                @foreach (var item in Order.Items)
                                {
                                    <div class="product-item">
                                        <div class="product-image">
                                            <img src="@item.ImageUrl" alt="@item.ProductName" />
                                        </div>
                                        <div class="product-details">
                                            <h4 class="product-name">@item.ProductName</h4>
                                            <p class="product-brand">@item.BrandName</p>
                                            <div class="product-variant">
                                                <span class="variant-item">Màu: @item.ColorName</span>
                                                <span class="variant-separator">•</span>
                                                <span class="variant-item">Size: @item.SizeName</span>
                                            </div>
                                            <div class="product-pricing">
                                                <span class="product-quantity">x@item.Quantity</span>
                                                <span class="product-price">@item.UnitPrice.ToString("N0")₫</span>
                                            </div>
                                        </div>
                                        <div class="product-subtotal">
                                            @item.Subtotal.ToString("N0")₫
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Order Summary -->
                        <div class="detail-section">
                            <h3 class="section-title">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                    <path d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM80 64h64c8.8 0 16 7.2 16 16s-7.2 16-16 16H80c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64h64c8.8 0 16 7.2 16 16s-7.2 16-16 16H80c-8.8 0-16-7.2-16-16s7.2-16 16-16zm54.2 253.8c-6.1 20.3-24.8 34.2-46 34.2H80c-8.8 0-16-7.2-16-16s7.2-16 16-16h8.2c7.1 0 13.3-4.6 15.3-11.4l14.9-49.5c3.4-11.3 13.8-19.1 25.6-19.1s22.2 7.7 25.6 19.1l11.6 38.6c7.4-6.2 16.8-9.7 26.8-9.7c15.9 0 30.4 9 37.5 23.2l4.4 8.8H304c8.8 0 16 7.2 16 16s-7.2 16-16 16H240c-6.1 0-11.6-3.4-14.3-8.8l-8.8-17.7c-1.7-3.4-5.1-5.5-8.8-5.5s-7.2 2.1-8.8 5.5l-8.8 17.7c-2.9 5.9-9.2 9.4-15.7 8.8s-12.1-5.1-13.9-11.3L144 349l-9.8 32.8z"/>
                                </svg>
                                Tổng kết đơn hàng
                            </h3>
                            <div class="summary-card">
                                <div class="summary-row">
                                    <span class="summary-label">Tạm tính:</span>
                                    <span class="summary-value">@Order.Summary.Subtotal.ToString("N0")₫</span>
                                </div>
                                <div class="summary-row">
                                    <span class="summary-label">Phí vận chuyển:</span>
                                    <span class="summary-value">@Order.Summary.ShippingFee.ToString("N0")₫</span>
                                </div>
                                @if (Order.Summary.Discount > 0)
                                {
                                    <div class="summary-row discount">
                                        <span class="summary-label">
                                            Giảm giá
                                            @if (Order.Voucher != null && !string.IsNullOrEmpty(Order.Voucher.VoucherCode))
                                            {
                                                <span class="voucher-code">(@Order.Voucher.VoucherCode)</span>
                                            }
                                        </span>
                                        <span class="summary-value">-@Order.Summary.Discount.ToString("N0")₫</span>
                                    </div>
                                }
                                <div class="summary-divider"></div>
                                <div class="summary-row total">
                                    <span class="summary-label">Tổng cộng:</span>
                                    <span class="summary-value">@Order.Summary.TotalAmount.ToString("N0")₫</span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Note -->
                        @if (!string.IsNullOrEmpty(Order.Note))
                        {
                            <div class="detail-section">
                                <h3 class="section-title">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                                        <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
                                    </svg>
                                    Ghi chú đơn hàng
                                </h3>
                                <div class="note-card">
                                    <p>@Order.Note</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HandleClose">Đóng</button>
                @if (Order.Status == 0)
                {
                    <button class="btn btn-success" @onclick="HandleConfirm">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                            <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
                        </svg>
                        Xác nhận đơn hàng
                    </button>
                    <button class="btn btn-danger" @onclick="HandleCancel">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                            <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                        </svg>
                        Hủy đơn hàng
                    </button>
                }
                @if (Order.Status == 1 || Order.Status == 2)
                {
                    <button class="btn btn-primary" @onclick="HandleShip">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="currentColor">
                            <path d="M112 0C85.5 0 64 21.5 64 48V96H16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 272c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 48c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 240c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 208c8.8 0 16 7.2 16 16s-7.2 16-16 16H64V416c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H112z"/>
                        </svg>
                        Giao hàng
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Show { get; set; }
    [Parameter] public AdminOrderDetail? Order { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnStatusChanged { get; set; }

    private ElementReference modalElement;
    private bool isSendingToGhn = false;
    private bool isRefreshingGhn = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Show && Order != null)
        {
            await JS.InvokeVoidAsync("eval", @"
                const modalOverlay = document.querySelector('.modal-overlay');
                const modalDialog = document.querySelector('.modal-dialog');
                
                if (modalOverlay) {
                    // Scroll overlay về đầu ngay lập tức
                    modalOverlay.scrollTop = 0;
                    modalOverlay.scrollTo({ top: 0, behavior: 'instant' });
                }
                
                // Delay nhỏ để đảm bảo DOM đã render
                setTimeout(() => {
                    if (modalDialog) {
                        // Focus vào modal để keyboard navigation hoạt động
                        modalDialog.focus();
                        
                        // Đảm bảo modal body cũng ở đầu
                        const modalBody = modalDialog.querySelector('.modal-body');
                        if (modalBody) {
                            modalBody.scrollTop = 0;
                        }
                    }
                }, 100);
            ");
        }
    }

    private void HandleOverlayClick()
    {
        // Chỉ đóng khi click trực tiếp vào overlay, không phải modal-dialog
        HandleClose();
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleConfirm()
    {
        Toast.Success("Đã xác nhận đơn hàng");
        await OnStatusChanged.InvokeAsync();
        await HandleClose();
    }

    private async Task HandleCancel()
    {
        Toast.Error("Đã hủy đơn hàng");
        await OnStatusChanged.InvokeAsync();
        await HandleClose();
    }

    private async Task HandleShip()
    {
        Toast.Info("Đơn hàng đang được giao");
        await OnStatusChanged.InvokeAsync();
        await HandleClose();
    }

    private string GetPaymentStatusClass(int status) => status switch
    {
        0 => "badge-warning",
        1 => "badge-success",
        2 => "badge-info",
        3 => "badge-danger",
        _ => "badge-secondary"
    };

    private string GetGhnStatusClass(string? status) => status?.ToLower() switch
    {
        "pending" => "badge-warning",
        "picking" => "badge-info",
        "delivering" => "badge-primary",
        "delivered" => "badge-success",
        "return" => "badge-danger",
        "cancel" => "badge-secondary",
        _ => "badge-secondary"
    };

    private async Task HandleSendToGhn()
    {
        if (Order == null || isSendingToGhn) return;

        try
        {
            isSendingToGhn = true;
            StateHasChanged();

            var request = new CreateGhnOrderRequest
            {
                OrderId = Order.OrderID,
                PaymentTypeId = 2, // Người nhận trả phí
                Note = Order.ShippingInfo.Note
            };

            var result = await ShippingService.CreateGhnOrderAsync(request);

            if (result != null && result.Success)
            {
                Toast.Success($"Đã gửi đơn lên GHN thành công! Mã: {result.GhnOrderCode}");
                
                // Cập nhật UI
                if (Order.Shipment != null)
                {
                    Order.Shipment.GhnOrderCode = result.GhnOrderCode;
                    Order.Shipment.GhnStatus = "pending";
                    Order.Shipment.GhnFee = result.TotalFee;
                    Order.Shipment.GhnCreatedAt = DateTime.Now;
                }

                await OnStatusChanged.InvokeAsync();
            }
            else
            {
                Toast.Error($"Gửi đơn GHN thất bại: {result?.Message ?? "Lỗi không xác định"}");
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"Lỗi khi gửi đơn GHN: {ex.Message}");
        }
        finally
        {
            isSendingToGhn = false;
            StateHasChanged();
        }
    }

    private async Task HandleRefreshGhnStatus()
    {
        if (Order == null || isRefreshingGhn) return;

        try
        {
            isRefreshingGhn = true;
            StateHasChanged();

            var tracking = await ShippingService.GetOrderTrackingAsync(Order.OrderID);

            if (tracking != null && Order.Shipment != null)
            {
                Order.Shipment.GhnStatus = tracking.GhnStatus;
                Order.Shipment.GhnFee = tracking.GhnFee;
                Order.Shipment.CodCollected = tracking.CodCollected;
                Order.Shipment.GhnUpdatedAt = tracking.LastUpdated;

                Toast.Success("Đã cập nhật trạng thái GHN");
                StateHasChanged();
            }
            else
            {
                Toast.Info("Không thể lấy thông tin tracking");
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"Lỗi khi làm mới trạng thái: {ex.Message}");
        }
        finally
        {
            isRefreshingGhn = false;
            StateHasChanged();
        }
    }

    private string GetGhnStatusText(string? status) => status?.ToLower() switch
    {
        "pending" => "Chờ lấy hàng",
        "picking" => "Đang lấy hàng",
        "delivering" => "Đang giao",
        "delivered" => "Đã giao",
        "return" => "Hoàn trả",
        "cancel" => "Đã hủy",
        _ => status ?? "Chưa xác định"
    };

    private async Task CopyToClipboard(string? text)
    {
        if (string.IsNullOrEmpty(text)) return;
        
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            Toast.Success("Đã sao chép mã đơn!");
        }
        catch
        {
            Toast.Info("Không thể sao chép. Vui lòng copy thủ công.");
        }
    }
}
