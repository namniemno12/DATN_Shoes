@page "/"
@attribute [Authorize]
@inject AdminWeb.Services.OrderService OrderService

<PageTitle>Dashboard - Asion Shop</PageTitle>

<!-- Statistics Cards Row -->
<div class="flex flex-wrap -mx-3">
    <!-- Card 1: Today's Money -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-4">
                <div class="flex flex-row -mx-3">
                    <div class="flex-none w-2/3 max-w-full px-3">
                        <div>
                            <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Doanh thu hôm nay</p>
                            <h5 class="mb-2 font-bold dark:text-white">@(statistics?.TotalRevenue.ToString("N0") ?? "0")₫</h5>
                            <p class="mb-0 dark:text-white dark:opacity-60">
                                <span class="text-sm font-bold leading-normal text-emerald-500">+55%</span>
                                so với tuần trước
                            </p>
                        </div>
                    </div>
                    <div class="px-3 text-right basis-1/3">
                        <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-blue-500 to-violet-500">
                            <i class="ni leading-none ni-money-coins text-lg relative top-3.5 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 2: Total Orders -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-4">
                <div class="flex flex-row -mx-3">
                    <div class="flex-none w-2/3 max-w-full px-3">
                        <div>
                            <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Tổng đơn hàng</p>
                            <h5 class="mb-2 font-bold dark:text-white">@(statistics?.TotalOrders ?? 0)</h5>
                            <p class="mb-0 dark:text-white dark:opacity-60">
                                <span class="text-sm font-bold leading-normal text-emerald-500">+3%</span>
                                so với tháng trước
                            </p>
                        </div>
                    </div>
                    <div class="px-3 text-right basis-1/3">
                        <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-red-600 to-orange-600">
                            <i class="ni leading-none ni-world text-lg relative top-3.5 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 3: Pending Orders -->
    <div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-4">
                <div class="flex flex-row -mx-3">
                    <div class="flex-none w-2/3 max-w-full px-3">
                        <div>
                            <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Chờ xác nhận</p>
                            <h5 class="mb-2 font-bold dark:text-white">@(statistics?.PendingOrders ?? 0)</h5>
                            <p class="mb-0 dark:text-white dark:opacity-60">
                                <span class="text-sm font-bold leading-normal text-red-600">Cần xử lý</span>
                            </p>
                        </div>
                    </div>
                    <div class="px-3 text-right basis-1/3">
                        <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400">
                            <i class="ni leading-none ni-paper-diploma text-lg relative top-3.5 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card 4: Average Order Value -->
    <div class="w-full max-w-full px-3 sm:w-1/2 sm:flex-none xl:w-1/4">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="flex-auto p-4">
                <div class="flex flex-row -mx-3">
                    <div class="flex-none w-2/3 max-w-full px-3">
                        <div>
                            <p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Giá trị TB/Đơn</p>
                            <h5 class="mb-2 font-bold dark:text-white">@(statistics?.AverageOrderValue.ToString("N0") ?? "0")₫</h5>
                            <p class="mb-0 dark:text-white dark:opacity-60">
                                <span class="text-sm font-bold leading-normal text-emerald-500">+5%</span>
                                so với hôm qua
                            </p>
                        </div>
                    </div>
                    <div class="px-3 text-right basis-1/3">
                        <div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-orange-500 to-yellow-500">
                            <i class="ni leading-none ni-cart text-lg relative top-3.5 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1: Revenue & Orders -->
<div class="flex flex-wrap mt-6 -mx-3">
    <!-- Revenue Chart -->
    <div class="w-full max-w-full px-3 mb-6 lg:mb-0 lg:w-7/12 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pb-0">
                <h6 class="dark:text-white mb-0">Biểu đồ doanh thu</h6>
                <p class="text-sm leading-normal dark:text-white dark:opacity-60 mb-0">
                    <i class="fa fa-arrow-up text-emerald-500"></i>
                    <span class="font-semibold">4% tăng</span> so với tuần trước
                </p>
            </div>
            <div class="flex-auto p-6">
                <canvas id="revenueChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Orders by Status Chart -->
    <div class="w-full max-w-full px-3 lg:w-5/12 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pb-0">
                <h6 class="dark:text-white mb-0">Trạng thái đơn hàng</h6>
                <p class="text-sm leading-normal dark:text-white dark:opacity-60 mb-0">
                    Phân bổ đơn hàng theo trạng thái
                </p>
            </div>
            <div class="flex-auto p-6">
                <canvas id="ordersChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 2: Products & Customer Growth -->
<div class="flex flex-wrap mt-6 -mx-3">
    <!-- Top Products Chart -->
    <div class="w-full max-w-full px-3 mb-6 lg:mb-0 lg:w-5/12 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pb-0">
                <h6 class="dark:text-white mb-0">Sản phẩm bán chạy</h6>
                <p class="text-sm leading-normal dark:text-white dark:opacity-60 mb-0">
                    Top 5 sản phẩm trong tháng
                </p>
            </div>
            <div class="flex-auto p-6">
                <canvas id="topProductsChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Customer Growth Chart -->
    <div class="w-full max-w-full px-3 lg:w-7/12 lg:flex-none">
        <div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border">
            <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pb-0">
                <h6 class="dark:text-white mb-0">Tăng trưởng khách hàng</h6>
                <p class="text-sm leading-normal dark:text-white dark:opacity-60 mb-0">
                    <i class="fa fa-arrow-up text-emerald-500"></i>
                    <span class="font-semibold">15% tăng</span> khách hàng mới
                </p>
            </div>
            <div class="flex-auto p-6">
                <canvas id="customerGrowthChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="flex flex-wrap mt-6 -mx-3">
    <div class="w-full max-w-full px-3 mt-0 lg:flex-none">
        <div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border">
            <div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pb-0">
                <h6 class="dark:text-white">Sản phẩm bán chạy nhất</h6>
                <p class="text-sm leading-normal dark:text-white dark:opacity-60">
                    <i class="fa fa-check text-cyan-500"></i>
                    <span class="ml-1 font-semibold">30 sản phẩm</span> trong tháng này
                </p>
            </div>
            <div class="flex-auto p-6">
                <div class="overflow-x-auto">
                    <table class="items-center w-full mb-0 align-top border-collapse dark:border-white/40 text-slate-500">
                        <thead class="align-bottom">
                            <tr>
                                <th class="px-6 py-3 font-bold text-left uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Sản phẩm</th>
                                <th class="px-6 py-3 pl-2 font-bold text-left uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Số lượng</th>
                                <th class="px-6 py-3 font-bold text-center uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Giá</th>
                                <th class="px-6 py-3 font-bold text-center uppercase align-middle bg-transparent border-b border-collapse shadow-none dark:border-white/40 dark:text-white text-xxs border-b-solid tracking-none whitespace-nowrap text-slate-400 opacity-70">Doanh thu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (statistics?.TopProducts != null && statistics.TopProducts.Any())
                            {
                                @foreach (var product in statistics.TopProducts.Take(5))
                                {
                                    <tr>
                                        <td class="p-2 align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
                                            <div class="flex px-2 py-1 gap-3 items-center">
                                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                                {
                                                    <img src="@product.ImageUrl" alt="@product.ProductName" class="w-12 h-12 object-cover rounded-lg shadow-sm" />
                                                }
                                                else
                                                {
                                                    <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                                                        <i class="fas fa-image text-gray-400"></i>
                                                    </div>
                                                }
                                                <div class="flex flex-col justify-center">
                                                    <h6 class="mb-0 text-sm leading-normal dark:text-white">@product.ProductName</h6>
                                                    <p class="mb-0 text-xs leading-tight dark:text-white dark:opacity-80 text-slate-400">ID: @product.ProductID</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="p-2 align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
                                            <p class="mb-0 text-xs font-semibold leading-tight dark:text-white dark:opacity-80">@product.TotalQuantity</p>
                                        </td>
                                        <td class="p-2 text-sm leading-normal text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
                                            <span class="text-xs font-semibold leading-tight dark:text-white dark:opacity-80 text-slate-400">@product.OrderCount đơn</span>
                                        </td>
                                        <td class="p-2 text-center align-middle bg-transparent border-b dark:border-white/40 whitespace-nowrap shadow-transparent">
                                            <span class="text-xs font-semibold leading-tight dark:text-white dark:opacity-80">₫@product.Revenue.ToString("N0")</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="p-4 text-center text-sm text-gray-500">Đang tải dữ liệu...</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private AdminWeb.Models.GetOrderStatisticsRes? statistics;
    private bool isLoading = true;
    private bool chartsInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    private async Task LoadStatistics()
    {
        isLoading = true;
        try
        {
            // Load statistics for last 30 days
            var fromDate = DateTime.Now.AddDays(-30);
            var toDate = DateTime.Now;
            statistics = await OrderService.GetOrderStatisticsForDashboardAsync(fromDate, toDate);
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!chartsInitialized && statistics != null && !isLoading)
        {
            chartsInitialized = true;
            // Pass statistics data to JavaScript
            await JSRuntime.InvokeVoidAsync("initDashboardCharts", statistics);
        }
    }
}

@inject IJSRuntime JSRuntime
