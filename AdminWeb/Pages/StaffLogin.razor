@page "/login"
@layout EmptyLayout
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>Đăng nhập - Asion Admin</PageTitle>

<link href="css/login.css" rel="stylesheet" />

<div class="login-wrapper">
    <!-- Background Animation -->
    <div class="animated-background">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="login-container">
        <!-- Left Side - Branding -->
        <div class="login-branding">
            <div class="brand-content">
                <div class="brand-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                        <path d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"/>
                    </svg>
                </div>
                <h1 class="brand-title">Asion Admin</h1>
                <p class="brand-subtitle">Hệ thống quản lý cửa hàng giày</p>
                <div class="brand-features">
                    <div class="feature-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                        </svg>
                        <span>Quản lý đơn hàng</span>
                    </div>
                    <div class="feature-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                        </svg>
                        <span>Quản lý sản phẩm</span>
                    </div>
                    <div class="feature-item">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                        </svg>
                        <span>Báo cáo thống kê</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Login Form -->
        <div class="login-form-section">
            <div class="form-wrapper">
                <div class="form-header">
                    <h2 class="form-title">Chào mừng trở lại</h2>
                    <p class="form-subtitle">Đăng nhập để tiếp tục quản lý cửa hàng</p>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-error">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/>
                        </svg>
                        <span>@errorMessage</span>
                    </div>
                }

                <EditForm Model="loginModel" OnValidSubmit="HandleLogin" class="login-form">
                    <DataAnnotationsValidator />
                    
                    <div class="form-group">
                        <label class="form-label">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                <path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/>
                            </svg>
                            Tên đăng nhập
                        </label>
                        <InputText id="username" 
                                   class="form-input" 
                                   placeholder="Nhập tên đăng nhập"
                                   @bind-Value="loginModel.UserName"
                                   disabled="@isLoading" />
                        <ValidationMessage For="@(() => loginModel.UserName)" class="validation-message" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                <path d="M144 144v48H304V144c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192V144C80 64.5 144.5 0 224 0s144 64.5 144 144v48h16c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64H80z"/>
                            </svg>
                            Mật khẩu
                        </label>
                        <div class="password-input-wrapper">
                            <InputText type="@(showPassword ? "text" : "password")" 
                                       id="password"
                                       class="form-input" 
                                       placeholder="Nhập mật khẩu"
                                       @bind-Value="loginModel.Password"
                                       disabled="@isLoading" />
                            <button type="button" class="toggle-password" @onclick="TogglePasswordVisibility">
                                @if (showPassword)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="currentColor">
                                        <path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c8.4-19.3 10.6-41.4 4.8-63.3c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zM373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5L373 389.9z"/>
                                    </svg>
                                }
                                else
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                        <path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/>
                                    </svg>
                                }
                            </button>
                        </div>
                        <ValidationMessage For="@(() => loginModel.Password)" class="validation-message" />
                    </div>

                    <div class="form-options">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="rememberMe" />
                            <span>Ghi nhớ đăng nhập</span>
                        </label>
                        <a href="#" class="forgot-password">Quên mật khẩu?</a>
                    </div>

                    <button type="submit" class="btn-login" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner"></span>
                            <span>Đang đăng nhập...</span>
                        }
                        else
                        {
                            <span>Đăng nhập</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                <path d="M438.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L338.8 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l306.7 0L233.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z"/>
                            </svg>
                        }
                    </button>
                </EditForm>

                <div class="form-footer">
                    <p>Bạn chưa có tài khoản? <a href="#" class="register-link">Đăng ký ngay</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginReq loginModel = new();
    private bool isLoading = false;
    private bool showPassword = false;
    private bool rememberMe = false;
    private string errorMessage = string.Empty;

    [Inject] private AuthService AuthService { get; set; } = default!;
    [Inject] private ToastService Toast { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // Kiểm tra xem đã đăng nhập chưa, nếu có token hợp lệ thì redirect
        var token = await JS.InvokeAsync<string>("localStorage.getItem", "admin_access_token");
        if (!string.IsNullOrEmpty(token))
        {
            Nav.NavigateTo("/", forceLoad: false);
        }
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
        if (isLoading) return;
        
        errorMessage = string.Empty;
        isLoading = true;
        
        try
        {
            var result = await AuthService.StaffLoginAsync(loginModel);
            
            if (result.Success && result.Data?.AccessToken != null)
            {
                // Lưu token và user ID vào localStorage
                await JS.InvokeVoidAsync("localStorage.setItem", "admin_access_token", result.Data.AccessToken);
                await JS.InvokeVoidAsync("localStorage.setItem", "admin_refresh_token", result.Data.RefreshToken ?? "");
                await JS.InvokeVoidAsync("localStorage.setItem", "admin_user_id", result.Data.UserID.ToString());
                
                if (rememberMe)
                {
                    await JS.InvokeVoidAsync("localStorage.setItem", "remember_login", "true");
                }
                
                // Notify authentication state provider
                if (AuthStateProvider is CustomAuthStateProvider customProvider)
                {
                    await customProvider.NotifyUserAuthentication(result.Data.AccessToken);
                }
                
                Toast.Success("Đăng nhập thành công! Chào mừng bạn.");
                
                // Điều hướng tới trang quản trị chính
                Nav.NavigateTo("/", forceLoad: true);
            }
            else
            {
                errorMessage = result.Message ?? "Đăng nhập thất bại. Vui lòng kiểm tra lại thông tin.";
                Toast.Error(errorMessage);
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Có lỗi xảy ra khi đăng nhập. Vui lòng thử lại.";
            Toast.Error(errorMessage);
            Console.WriteLine($"Login error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}