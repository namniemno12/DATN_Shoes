@page "/orders"
@attribute [Authorize]
@inject AdminWeb.Services.OrderService OrderService
@inject AdminWeb.Services.ToastService Toast
@using DAL.DTOs.Orders.Res

<PageTitle>Quản lý Đơn hàng - Asion Shop</PageTitle>

<link href="css/orders-enhanced.css?v=2" rel="stylesheet" />
<link href="css/order-detail-dialog.css?v=2" rel="stylesheet" />

<div class="orders-container">
    <!-- Statistics Dashboard -->
    <div class="stats-dashboard">
        <div class="stat-card stat-total">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                    <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22.1 0 41.5 15.2 46.4 36.7L128 64H544c17.7 0 32 14.3 32 32c0 3.4-.5 6.7-1.4 9.8l-63.1 216.9c-8.5 29.2-35.4 49.3-65.7 49.3H192c-30.3 0-57.2-20.1-65.7-49.3L44.2 80H24C10.7 80 0 69.3 0 56V24zM160 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm288-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z" />
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-label">Tổng đơn hàng</div>
                <div class="stat-value">@statistics?.TotalOrders.ToString("N0")</div>
                <div class="stat-change positive">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                        <path d="M214.6 41.4c-12.5-12.5-32.8-12.5-45.3 0l-160 160c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L160 141.2V448c0 17.7 14.3 32 32 32s32-14.3 32-32V141.2L329.4 246.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-160-160z"/>
                    </svg>
                    <span>12% tháng trước</span>
                </div>
            </div>
        </div>

        <div class="stat-card stat-pending">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-label">Chờ xác nhận</div>
                <div class="stat-value">@statistics?.PendingOrders.ToString("N0")</div>
                <div class="stat-note">Cần xử lý ngay</div>
            </div>
        </div>

        <div class="stat-card stat-processing">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                    <path d="M304 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zm0 416a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96zm464-48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM142.9 437A48 48 0 1 0 75 369.1 48 48 0 1 0 142.9 437zm0-294.2A48 48 0 1 0 75 75a48 48 0 1 0 67.9 67.9zM369.1 437A48 48 0 1 0 437 369.1 48 48 0 1 0 369.1 437z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-label">Đang xử lý</div>
                <div class="stat-value">@statistics?.ProcessingOrders.ToString("N0")</div>
                <div class="stat-note">Đang chuẩn bị</div>
            </div>
        </div>

        <div class="stat-card stat-shipping">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="currentColor">
                    <path d="M112 0C85.5 0 64 21.5 64 48V96H16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 272c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 48c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 240c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 208c8.8 0 16 7.2 16 16s-7.2 16-16 16H64V416c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H112zM544 237.3V256H416V160h50.7L544 237.3zM160 464a48 48 0 1 1 0-96 48 48 0 1 1 0 96zm368-48a48 48 0 1 1 -96 0 48 48 0 1 1 96 0z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-label">Đang giao hàng</div>
                <div class="stat-value">@statistics?.ShippingOrders.ToString("N0")</div>
                <div class="stat-note">Đang vận chuyển</div>
            </div>
        </div>

        <div class="stat-card stat-completed">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-label">Hoàn thành</div>
                <div class="stat-value">@statistics?.DeliveredOrders.ToString("N0")</div>
                <div class="stat-note">Đã giao thành công</div>
            </div>
        </div>

        <div class="stat-card stat-revenue">
            <div class="stat-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                    <path d="M64 64C28.7 64 0 92.7 0 128V384c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V128c0-35.3-28.7-64-64-64H64zm64 320H64V320c35.3 0 64 28.7 64 64zM64 192V128h64c0 35.3-28.7 64-64 64zM448 384c0-35.3 28.7-64 64-64v64H448zm64-192c-35.3 0-64-28.7-64-64h64v64zM288 160a96 96 0 1 1 0 192 96 96 0 1 1 0-192z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-label">Tổng doanh thu</div>
                <div class="stat-value">@statistics?.TotalRevenue.ToString("N0")₫</div>
                <div class="stat-note">Trung bình: @statistics?.AverageOrderValue.ToString("N0")₫</div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-header">
            <h2 class="page-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                    <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22.1 0 41.5 15.2 46.4 36.7L128 64H544c17.7 0 32 14.3 32 32c0 3.4-.5 6.7-1.4 9.8l-63.1 216.9c-8.5 29.2-35.4 49.3-65.7 49.3H192c-30.3 0-57.2-20.1-65.7-49.3L44.2 80H24C10.7 80 0 69.3 0 56V24z"/>
                </svg>
                Danh sách đơn hàng
            </h2>
            <button class="btn-refresh" @onclick="RefreshData" disabled="@isLoading">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                    <path d="M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H336c-17.7 0-32 14.3-32 32s14.3 32 32 32H463.5c0 0 0 0 0 0h.4c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v51.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5z"/>
                </svg>
                @(isLoading ? "Đang tải..." : "Làm mới")
            </button>
        </div>

        <div class="filters-controls">
            <!-- Search Bar - Full Width -->
            <div class="filter-group filter-search">
                <div class="search-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                        <path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208z"/>
                    </svg>
                    <input type="text" 
                           class="filter-input search-input" 
                           placeholder="Tìm kiếm mã đơn, tên khách hàng, số điện thoại..." 
                           @bind="filterKeyword" 
                           @bind:event="oninput"
                           @onkeyup="OnSearchKeyUp" />
                </div>
            </div>

            <!-- Filter Row -->
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Trạng thái đơn</label>
                    <select class="filter-select" @bind="filterStatus" @bind:after="ApplyFilters">
                        <option value="">Tất cả</option>
                        <option value="0">Chờ xác nhận</option>
                        <option value="1">Đã xác nhận</option>
                        <option value="2">Đang xử lý</option>
                        <option value="3">Đang giao</option>
                        <option value="4">Đã giao</option>
                        <option value="5">Đã hủy</option>
                        <option value="6">Đã trả hàng</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Thanh toán</label>
                    <select class="filter-select" @bind="filterPaymentStatus" @bind:after="ApplyFilters">
                        <option value="">Tất cả</option>
                        <option value="0">Chưa thanh toán</option>
                        <option value="1">Đã thanh toán</option>
                        <option value="2">Đã hoàn tiền</option>
                        <option value="3">Thất bại</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Phương thức</label>
                    <select class="filter-select" @bind="filterPaymentMethod" @bind:after="ApplyFilters">
                        <option value="">Tất cả</option>
                        <option value="1">COD</option>
                        <option value="2">VNPAY</option>
                        <option value="3">GPAY</option>
                        <option value="4">PAYPAL</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Từ ngày</label>
                    <input type="date" class="filter-input" @bind="filterFromDate" @bind:after="ApplyFilters" />
                </div>

                <div class="filter-group">
                    <label class="filter-label">Đến ngày</label>
                    <input type="date" class="filter-input" @bind="filterToDate" @bind:after="ApplyFilters" />
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="orders-table-wrapper">
        @if (isLoading)
        {
            <div class="loading-overlay">
                <div class="spinner"></div>
                <p>Đang tải dữ liệu...</p>
            </div>
        }
        else if (orders == null || !orders.Any())
        {
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                    <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
                </svg>
                <h3>Không tìm thấy đơn hàng</h3>
                <p>Không có đơn hàng nào phù hợp với bộ lọc của bạn</p>
            </div>
        }
        else
        {
            <div class="orders-grid">
                @foreach (var order in orders)
                {
                    <div class="order-card @GetStatusClass(order.Status)">
                        <!-- Card Header -->
                        <div class="card-header">
                            <div class="header-left">
                                <h3 class="order-code-title">@order.OrderCode</h3>
                                <span class="items-badge">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                        <path d="M0 24C0 10.7 10.7 0 24 0H69.5c22.1 0 41.5 15.2 46.4 36.7L128 64H544c17.7 0 32 14.3 32 32c0 3.4-.5 6.7-1.4 9.8l-63.1 216.9c-8.5 29.2-35.4 49.3-65.7 49.3H192c-30.3 0-57.2-20.1-65.7-49.3L44.2 80H24C10.7 80 0 69.3 0 56V24z"/>
                                    </svg>
                                    @order.ItemCount sản phẩm
                                </span>
                            </div>
                            <div class="header-right">
                                <span class="status-badge @GetStatusClass(order.Status)">
                                    @order.StatusText
                                </span>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="card-body">
                            <!-- Customer Section -->
                            <div class="info-section customer-section">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                        <path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z"/>
                                    </svg>
                                </div>
                                <div class="section-content">
                                    <div class="section-label">Khách hàng</div>
                                    <div class="section-value">@order.CustomerName</div>
                                    <div class="section-extra">@order.CustomerPhone</div>
                                </div>
                            </div>

                            <!-- Date Section -->
                            <div class="info-section date-section">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                        <path d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24z"/>
                                    </svg>
                                </div>
                                <div class="section-content">
                                    <div class="section-label">Ngày đặt</div>
                                    <div class="section-value">@order.OrderDate.ToString("dd/MM/yyyy")</div>
                                    <div class="section-extra">@order.OrderDate.ToString("HH:mm")</div>
                                </div>
                            </div>

                            <!-- Payment Section -->
                            <div class="info-section payment-section">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                        <path d="M64 64C28.7 64 0 92.7 0 128v64c0 8.8 7.4 15.7 15.7 18.6C34.5 217.1 48 235 48 256s-13.5 38.9-32.3 45.4C7.4 304.3 0 311.2 0 320v64c0 35.3 28.7 64 64 64H512c35.3 0 64-28.7 64-64V320c0-8.8-7.4-15.7-15.7-18.6C541.5 294.9 528 277 528 256s13.5-38.9 32.3-45.4c8.3-2.9 15.7-9.8 15.7-18.6V128c0-35.3-28.7-64-64-64H64z"/>
                                    </svg>
                                </div>
                                <div class="section-content">
                                    <div class="section-label">Thanh toán</div>
                                    <div class="section-value">@order.PaymentMethodText</div>
                                    <div class="payment-status @GetPaymentStatusClass(order.PaymentStatus)">
                                        @order.PaymentStatusText
                                    </div>
                                </div>
                            </div>

                            <!-- Amount Section -->
                            <div class="info-section amount-section">
                                <div class="section-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
                                        <path d="M160 0c17.7 0 32 14.3 32 32V67.7c1.6 .2 3.1 .4 4.7 .7c.4 .1 .7 .1 1.1 .2l48 8.8c17.4 3.2 28.9 19.9 25.7 37.2s-19.9 28.9-37.2 25.7l-47.5-8.7c-31.3-4.6-58.9-1.5-78.3 6.2s-27.2 18.3-29 28.1c-2 10.7-.5 16.7 1.2 20.4c1.8 3.9 5.5 8.3 12.8 13.2c16.3 10.7 41.3 17.7 73.7 26.3l2.9 .8c28.6 7.6 63.6 16.8 89.6 33.8c14.2 9.3 27.6 21.9 35.9 39.5c8.5 17.9 10.3 37.9 6.4 59.2c-6.9 38-33.1 63.4-65.6 76.7c-13.7 5.6-28.6 9.2-44.4 11V480c0 17.7-14.3 32-32 32s-32-14.3-32-32V445.1c-.4-.1-.9-.1-1.3-.2l-.2 0 0 0c-24.4-3.8-64.5-14.3-91.5-26.3c-16.1-7.2-23.4-26.1-16.2-42.2s26.1-23.4 42.2-16.2c20.9 9.3 55.3 18.5 75.2 21.6c31.9 4.7 58.2 2 76-5.3c16.9-6.9 24.6-16.9 26.8-28.9c1.9-10.6 .4-16.7-1.3-20.4c-1.9-4-5.6-8.4-13-13.3c-16.4-10.7-41.5-17.7-74-26.3l-2.8-.7 0 0C119.4 279.3 84.4 270 58.4 253c-14.2-9.3-27.5-22-35.8-39.6c-8.4-17.9-10.1-37.9-6.1-59.2C23.7 116 52.3 91.2 84.8 78.3c13.3-5.3 27.9-8.9 43.2-11V32c0-17.7 14.3-32 32-32z"/>
                                    </svg>
                                </div>
                                <div class="section-content">
                                    <div class="section-label">Tổng tiền</div>
                                    <div class="section-value amount-value">@order.TotalAmount.ToString("N0")₫</div>
                                </div>
                            </div>
                        </div>

                        <!-- Card Footer -->
                        <div class="card-footer">
                            <button class="action-button btn-view" 
                                    @onclick="() => ViewOrderDetail(order.OrderID)">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" fill="currentColor">
                                    <path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z"/>
                                </svg>
                                Xem chi tiết
                            </button>
                            
                            @if (order.Status == 0)
                            {
                                <button class="action-button btn-confirm" 
                                        @onclick="() => ConfirmOrder(order.OrderID)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor">
                                        <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
                                    </svg>
                                    Xác nhận
                                </button>
                                <button class="action-button btn-cancel" 
                                        @onclick="() => CancelOrder(order.OrderID)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor">
                                        <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                                    </svg>
                                    Hủy đơn
                                </button>
                            }
                            @if (order.Status == 1 || order.Status == 2)
                            {
                                <button class="action-button btn-ship" 
                                        @onclick="() => ShipOrder(order.OrderID)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" fill="currentColor">
                                        <path d="M112 0C85.5 0 64 21.5 64 48V96H16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 272c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 48c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 240c8.8 0 16 7.2 16 16s-7.2 16-16 16H64 16c-8.8 0-16 7.2-16 16s7.2 16 16 16H64 208c8.8 0 16 7.2 16 16s-7.2 16-16 16H64V416c0 53 43 96 96 96s96-43 96-96H384c0 53 43 96 96 96s96-43 96-96h32c17.7 0 32-14.3 32-32s-14.3-32-32-32V288 256 237.3c0-17-6.7-33.3-18.7-45.3L512 114.7c-12-12-28.3-18.7-45.3-18.7H416V48c0-26.5-21.5-48-48-48H112z"/>
                                    </svg>
                                    Giao hàng
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Pagination -->
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    Hiển thị @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, totalRecords) của @totalRecords đơn hàng
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" 
                            @onclick="() => ChangePage(1)" 
                            disabled="@(currentPage == 1)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160zm352-160l-160 160c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L301.3 256 438.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0z"/>
                        </svg>
                    </button>
                    <button class="page-btn" 
                            @onclick="() => ChangePage(currentPage - 1)" 
                            disabled="@(currentPage == 1)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
                            <path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/>
                        </svg>
                    </button>
                    
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        var pageNum = i;
                        <button class="page-btn @(pageNum == currentPage ? "active" : "")" 
                                @onclick="() => ChangePage(pageNum)">
                            @pageNum
                        </button>
                    }
                    
                    <button class="page-btn" 
                            @onclick="() => ChangePage(currentPage + 1)" 
                            disabled="@(currentPage == totalPages)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
                            <path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/>
                        </svg>
                    </button>
                    <button class="page-btn" 
                            @onclick="() => ChangePage(totalPages)" 
                            disabled="@(currentPage == totalPages)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>
</div>

<!-- Order Detail Modal -->
<OrderDetailDialog Show="@showDetailModal"
                   Order="@selectedOrder"
                   IsLoading="@isDetailLoading"
                   OnClose="CloseDetailModal"
                   OnStatusChanged="LoadData" />

@code {
    private List<AdminOrderListItem> orders = new();
    private OrderStatisticsSummary? statistics;
    private AdminOrderDetail? selectedOrder;
    private bool showDetailModal = false;
    private bool isDetailLoading = false;
    private bool isLoading = false;

    // Filter properties
    private string filterKeyword = string.Empty;
    private string filterStatus = string.Empty;
    private string filterPaymentStatus = string.Empty;
    private string filterPaymentMethod = string.Empty;
    private DateTime? filterFromDate = null;
    private DateTime? filterToDate = null;

    // Pagination
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalRecords = 0;
    private int totalPages => (int)Math.Ceiling((double)totalRecords / pageSize);

    private System.Threading.Timer? searchTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Load statistics using new summary API
            statistics = await OrderService.GetOrderStatisticsSummaryAsync();

            // Load orders
            int? statusFilter = string.IsNullOrEmpty(filterStatus) ? null : int.Parse(filterStatus);
            int? paymentStatusFilter = string.IsNullOrEmpty(filterPaymentStatus) ? null : int.Parse(filterPaymentStatus);
            int? paymentMethodFilter = string.IsNullOrEmpty(filterPaymentMethod) ? null : int.Parse(filterPaymentMethod);

            var result = await OrderService.GetAllOrdersAsync(
                currentPage,
                pageSize,
                string.IsNullOrEmpty(filterKeyword) ? null : filterKeyword,
                statusFilter,
                paymentStatusFilter,
                paymentMethodFilter,
                filterFromDate,
                filterToDate
            );

            orders = result.Orders;
            totalRecords = result.TotalRecords;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSearchKeyUp()
    {
        searchTimer?.Dispose();
        searchTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                currentPage = 1;
                await LoadData();
            });
        }, null, 500, Timeout.Infinite);
    }

    private async Task ApplyFilters()
    {
        currentPage = 1;
        await LoadData();
    }

    private async Task ChangePage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadData();
    }

    private async Task RefreshData()
    {
        await LoadData();
        Toast.Success("Đã làm mới dữ liệu");
    }

    private async Task ViewOrderDetail(int orderId)
    {
        isDetailLoading = true;
        showDetailModal = true;
        selectedOrder = null;
        StateHasChanged();

        try
        {
            var detail = await OrderService.GetOrderDetailAsync(orderId);
            if (detail != null)
            {
                selectedOrder = detail;
            }
            else
            {
                Toast.Error("Không tải được chi tiết đơn hàng");
                showDetailModal = false;
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"Lỗi tải chi tiết đơn hàng: {ex.Message}");
            showDetailModal = false;
        }
        finally
        {
            isDetailLoading = false;
            StateHasChanged();
        }
    }

    private void CloseDetailModal()
    {
        showDetailModal = false;
        selectedOrder = null;
        isDetailLoading = false;
    }

    private async Task ConfirmOrder(int orderId)
    {
        var request = new ConfirmOrderRequest
        {
            OrderID = orderId,
            ShippingProvider = "Giao Hàng Nhanh",
            EstimatedDelivery = DateTime.Now.AddDays(3),
            Note = "Đơn hàng đã được xác nhận"
        };

        var trackingNumber = await OrderService.ConfirmOrderAsync(request);
        if (trackingNumber != null)
        {
            Toast.Success($"Đã xác nhận đơn hàng. Mã vận đơn: {trackingNumber}");
            // Delay nhỏ để backend cập nhật stats
            await Task.Delay(300);
            await LoadData();
        }
        else
        {
            Toast.Error("Không thể xác nhận đơn hàng");
        }
    }

    private async Task CancelOrder(int orderId)
    {
        var request = new CancelOrderRequest
        {
            OrderID = orderId,
            CancelReason = "Admin hủy đơn",
            RefundRequired = false
        };

        var success = await OrderService.CancelOrderAsync(request);
        if (success)
        {
            Toast.Success("Đã hủy đơn hàng");
            // Delay nhỏ để backend cập nhật stats
            await Task.Delay(300);
            await LoadData();
        }
        else
        {
            Toast.Error("Không thể hủy đơn hàng");
        }
    }

    private async Task ShipOrder(int orderId)
    {
        var request = new UpdateOrderStatusRequest
        {
            OrderID = orderId,
            NewStatus = 3,
            Note = "Đơn hàng đang được giao"
        };

        var success = await OrderService.UpdateOrderStatusAsync(request);
        if (success)
        {
            Toast.Success("Đơn hàng đang được giao");
            // Delay nhỏ để backend cập nhật stats
            await Task.Delay(300);
            await LoadData();
        }
        else
        {
            Toast.Error("Không thể cập nhật trạng thái");
        }
    }

    private string GetStatusClass(int status) => status switch
    {
        0 => "status-pending",
        1 => "status-confirmed",
        2 => "status-processing",
        3 => "status-shipping",
        4 => "status-delivered",
        5 => "status-cancelled",
        6 => "status-returned",
        _ => "status-unknown"
    };

    private string GetPaymentStatusClass(int status) => status switch
    {
        0 => "payment-unpaid",
        1 => "payment-paid",
        2 => "payment-refunded",
        3 => "payment-failed",
        _ => "payment-unknown"
    };

    public void Dispose()
    {
        searchTimer?.Dispose();
    }
}
