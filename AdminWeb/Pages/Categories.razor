@page "/categories"
@inject AdminWeb.Services.CategoryService CategoryService
@inject AdminWeb.Services.ToastService Toast
@using DAL.DTOs.Categories.Req
@using DAL.DTOs.Categories.Res
@using AdminWeb.Models

<PageTitle>Danh mục - Asion Shop</PageTitle>
<link href="css/categories.css" rel="stylesheet" />
<link href="css/modal-styles.css" rel="stylesheet" />

<div class="categories-page space-y-8">
    <!-- Stats Row -->
    <div class="stat-row">
        <div class="stat-card total">
            <div class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="28" height="28" fill="currentColor">
                    <path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zm64 0v64h64V96H64zm384 0H192v64H448V96zM64 224v64h64V224H64zm384 0H192v64H448V224zM64 352v64h64V352H64zm384 0H192v64H448V352z"/>
                </svg>
            </div>
            <div class="info">
                <p>Tổng danh mục</p>
                <h4>@totalRecords</h4>
            </div>
        </div>
        <div class="stat-card pending">
            <div class="icon" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="28" height="28" fill="currentColor">
                    <path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"/>
                </svg>
            </div>
            <div class="info">
                <p>Tổng sản phẩm</p>
                <h4>@totalProducts</h4>
            </div>
        </div>
    </div>

    <!-- Category List Table -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
        <!-- Add Category Button -->
        <div class="mb-4 flex justify-end">
            <button class="px-4 py-2 btn-ocean text-sm font-medium rounded-lg flex items-center gap-2" @onclick="OpenCreateModal">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>
                Thêm danh mục
            </button>
        </div>

        @if (loading)
        {
            <div class="flex items-center justify-center py-20">
                <div class="animate-spin rounded-full h-14 w-14 border-t-2 border-b-2 border-red-500"></div>
            </div>
        }
        else
        {
            <div class="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
                <table class="min-w-full w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tên danh mục</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Mô tả</th>
                            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Sản phẩm</th>
                            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Icon</th>
                            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white">
                        @foreach (var cat in categories)
                        {
                            <tr class="group hover:bg-gray-50 transition cursor-pointer">
                                <td class="px-6 py-4 align-middle">
                                    <p class="text-base font-semibold text-gray-900">@cat.Name</p>
                                </td>
                                <td class="px-6 py-4 align-middle">
                                    <p class="text-base text-gray-600 max-w-2xl truncate">@(cat.Description ?? "Chưa có mô tả")</p>
                                </td>
                                <td class="px-6 py-4 text-center align-middle">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-600">@cat.TotalProduct</span>
                                </td>
                                <td class="px-6 py-4 text-center align-middle">
                                    <span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-xl font-semibold bg-red-100 text-red-600" style="width:32px;height:32px;">
                                        <i class="@cat.Icon"></i>
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-center align-middle">
                                    <div class="flex items-center justify-center gap-2">
                                        <button @onclick="() => OpenDetailModal(cat)" class="action-btn btn-view" title="Xem chi tiết" style="background:#e0edff;color:#2563eb;border-radius:8px;padding:6px 10px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="18" height="18" fill="currentColor" aria-hidden="true"><path d="M572.52 241.4C518.9 135.59 407.81 64 288 64 168.19 64 57.1 135.59 3.48 241.4a32.35 32.35 0 0 0 0 29.2C57.1 376.41 168.19 448 288 448c119.81 0 230.9-71.59 284.52-177.4a32.35 32.35 0 0 0 0-29.2zM288 400c-97 0-176-79-176-176S191 48 288 48s176 79 176 176-79 176-176 176zm0-304a128 128 0 1 0 128 128A128 128 0 0 0 288 96z"/></svg>
                                        </button>
                                        <button @onclick="() => OpenEditModal(cat)" class="action-btn btn-accept" title="Sửa" style="background:#e6fbe8;color:#059669;border-radius:8px;padding:6px 10px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160V416c0 53 43 96 96 96H352c53 0 96-43 96-96V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v96c0 17.7-14.3 32-32 32H96c-17.7 0-32-14.3-32-32V160c0-17.7 14.3-32 32-32h96c17.7 0 32-14.3 32-32s-14.3-32-32-32H96z"/></svg>
                                        </button>
                                        <button @onclick="() => OpenDeleteConfirm(cat)" class="action-btn btn-reject" title="Xóa" style="background:#ffeaea;color:#dc2626;border-radius:8px;padding:6px 10px;">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="16" height="16" fill="currentColor" aria-hidden="true"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
           
            <!-- Pagination -->
            <div class="pagination-wrapper">
                <div class="pagination-info">
                    Hiển thị @((currentPage - 1) * recordPerPage + 1) - @Math.Min(currentPage * recordPerPage, totalRecords) của @totalRecords danh mục
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" 
                            @onclick="() => OnPageChanged(1)" 
                            disabled="@(currentPage == 1)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160zm352-160l-160 160c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L301.3 256 438.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0z"/>
                        </svg>
                    </button>
                    <button class="page-btn" 
                            @onclick="() => OnPageChanged(currentPage - 1)" 
                            disabled="@(currentPage == 1)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
                            <path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/>
                        </svg>
                    </button>
                    
                    @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                    {
                        var pageNum = i;
                        <button class="page-btn @(pageNum == currentPage ? "active" : "")" 
                                @onclick="() => OnPageChanged(pageNum)">
                            @pageNum
                        </button>
                    }
                    
                    <button class="page-btn" 
                            @onclick="() => OnPageChanged(currentPage + 1)" 
                            disabled="@(currentPage == totalPages)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" fill="currentColor">
                            <path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/>
                        </svg>
                    </button>
                    <button class="page-btn" 
                            @onclick="() => OnPageChanged(totalPages)" 
                            disabled="@(currentPage == totalPages)">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
                            <path d="M470.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 256 265.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160zm-352 160l160-160c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L210.7 256 73.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        }
    </div>

    <!-- Detail Modal -->
    @if (showDetailModal && selectedCategory != null)
    {
        <div class="modal fade show d-flex align-items-center justify-content-center" tabindex="-1" role="dialog" aria-modal="true" style="display:flex !important; background:rgba(0,0,0,0.5);" @onclick="CloseDetailModal">
            <div class="modal-dialog modal-sm" role="document" @onclick:stopPropagation>
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="18" height="18" fill="#3b82f6">
                                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336h24V272H216c-13.3 0-24-10.7-24-24s10.7-24 24-24h48c13.3 0 24 10.7 24 24v88h8c13.3 0 24 10.7 24 24s-10.7 24-24 24H216c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/>
                            </svg>
                            Chi tiết danh mục
                        </h5>
                        <button type="button" class="btn-close" aria-label="Đóng" @onclick="CloseDetailModal"></button>
                    </div>

                    <div class="modal-body">
                        <!-- Category Avatar & Name -->
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <div class="category-avatar">
                                <i class="@selectedCategory.Icon"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold fs-5">@selectedCategory.Name</h6>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-light text-dark border" style="font-size: 0.7rem;">ID: @selectedCategory.CategoryID</span>
                                </div>
                            </div>
                        </div>

                        <div class="modal-divider"></div>

                        <!-- Description -->
                        <div class="detail-info-row">
                            <div class="detail-info-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="12" height="12" fill="currentColor" class="me-1">
                                    <path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7z"/>
                                </svg>
                                Mô tả
                            </div>
                            <div class="detail-info-value">@(selectedCategory.Description ?? "Chưa có mô tả")</div>
                        </div>
                        <!-- Total Products -->
                        <div class="detail-info-row">
                            <div class="detail-info-label">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="12" height="12" fill="currentColor" class="me-1"><path d="M0 96C0 60.7 28.7 32 64 32H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V96zm64 0v64h64V96H64zm384 0H192v64H448V96zM64 224v64h64V224H64zm384 0H192v64H448V224zM64 352v64h64V352H64zm384 0H192v64H448V352z"/></svg>
                                Sản phẩm
                            </div>
                            <div class="detail-info-value">@selectedCategory.TotalProduct</div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" @onclick="CloseDetailModal">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" width="12" height="12" fill="currentColor">
                                <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                            </svg>
                            Đóng
                        </button>
                        <button type="button" class="btn btn-primary" @onclick="() => { CloseDetailModal(); OpenEditModal(selectedCategory); }">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="12" height="12" fill="currentColor">
                                <path d="M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7z"/>
                            </svg>
                            Chỉnh sửa
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    <!-- Edit Modal -->
    @if (showEditModal)
    {
        <div class="modal fade show d-flex align-items-center justify-content-center" tabindex="-1" role="dialog" aria-modal="true" style="display:flex !important; background:rgba(0,0,0,0.45);" @onclick="CloseEditModal">
            <div class="modal-dialog" role="document" @onclick:stopPropagation>
                <div class="modal-content rounded-3 shadow">
                    <div class="modal-header bg-light border-0">
                        <h5 class="modal-title fw-bold">@(isEdit ? "Chỉnh sửa danh mục" : "Thêm danh mục mới")</h5>
                        <button type="button" class="btn-close" aria-label="Đóng" @onclick="CloseEditModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label small fw-semibold">Tên danh mục <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" placeholder="Nhập tên danh mục..." @bind="formName" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold">Mô tả</label>
                            <textarea class="form-control form-control-sm" rows="3" placeholder="Nhập mô tả..." @bind="formDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-semibold">Icon</label>
                            <input type="text" class="form-control form-control-sm" placeholder="fa-solid fa-box" @bind="formIcon" />
                            <small class="text-muted d-block mt-1">
                                Gợi ý: truy cập
                                <a href="https://fontawesome.com/search?o=r&m=free" target="_blank" rel="noopener noreferrer">Font Awesome</a>
                                để chọn icon. Copy class ví dụ:
                                <code>fa-solid fa-box</code>, <code>fa-regular fa-star</code>, <code>fa-brands fa-apple</code>.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="CloseEditModal">Hủy</button>
                            <button type="button" class="btn btn-sm btn-primary" disabled="@isSaving" @onclick="SaveCategoryAsync">
                                @(isSaving ? "Đang lưu..." : (isEdit ? "Cập nhật" : "Lưu"))
                            </button>
                    </div>
                </div>
            </div>
        </div>
    }
    <!-- Delete Confirm Modal -->
    @if (showDeleteConfirm && categoryToDelete != null)
    {
        <div class="modal fade show d-flex align-items-center justify-content-center" tabindex="-1" style="display:flex !important; background:rgba(0,0,0,0.5);" aria-modal="true" role="dialog" @onclick="CloseDeleteConfirm">
            <div class="modal-dialog modal-sm" @onclick:stopPropagation>
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white py-2 px-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="bg-white rounded-circle d-flex align-items-center justify-content-center" style="width:32px;height:32px;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="18" height="18" fill="#dc2626">
                                    <path d="M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480H40c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24V296c0 13.3 10.7 24 24 24s24-10.7 24-24V184c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z"/>
                                </svg>
                            </span>
                            <h5 class="modal-title ms-2 mb-0">Xác nhận xóa</h5>
                        </div>
                        <button type="button" class="btn-close btn-close-white ms-2" aria-label="Đóng" @onclick="CloseDeleteConfirm"></button>
                    </div>
                    <div class="modal-body py-3 px-3">
                        <div class="alert alert-danger mb-2 p-2 text-center">
                            <div class="fw-bold">@categoryToDelete.Name</div>
                            <div class="small">Bạn có chắc chắn muốn xóa danh mục này?</div>
                        </div>
                        <div class="d-flex align-items-center gap-2 text-danger justify-content-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="14" height="14" fill="currentColor">
                                <path d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zm32 224a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"/>
                            </svg>
                            <span class="small">Hành động này không thể hoàn tác.</span>
                        </div>
                    </div>
                    <div class="modal-footer py-2 px-3 d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CloseDeleteConfirm">Hủy</button>
                        <button type="button" class="btn btn-danger btn-sm" disabled="@isSaving" @onclick="DeleteCategoryAsync">
                            @(isSaving ? "Đang xóa..." : "Xóa")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<CategoryExtended> categories = new();
    private int totalRecords = 0;
    private int currentPage = 1;
    private int totalPages = 1;
    private int recordPerPage = 10;
    private bool loading = true;
    private int totalProducts = 0;

    // Detail modal state
    private bool showDetailModal = false;
    private CategoryExtended? selectedCategory;

    // Edit modal state
    private bool showEditModal = false;
    private bool isEdit = false;
    private bool isSaving = false;
    private int formCategoryID;
    private string formName = string.Empty;
    private string formDescription = string.Empty;
    private string formIcon = string.Empty;

    // Delete confirm state
    private bool showDeleteConfirm = false;
    private CategoryExtended? categoryToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        loading = true;
        var result = await CategoryService.GetAllCategoryExtendedAsync(currentPage, recordPerPage);
        categories = result.Data;
        totalRecords = result.TotalRecords;
        totalPages = result.TotalPages;
        totalProducts = categories.Sum(c => c.TotalProduct);
        loading = false;
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadCategories();
    }

    private void OpenDetailModal(CategoryExtended cat)
    {
        selectedCategory = cat;
        showDetailModal = true;
    }

    private void CloseDetailModal()
    {
        showDetailModal = false;
        selectedCategory = null;
    }

    private void OpenEditModal(CategoryExtended cat)
    {
        isEdit = true;
        formCategoryID = cat.CategoryID;
        formName = cat.Name;
        formDescription = cat.Description ?? string.Empty;
        formIcon = cat.Icon;
        showEditModal = true;
    }
    private void CloseEditModal()
    {
        showEditModal = false;
        isEdit = false;
    }
    private void OpenDeleteConfirm(CategoryExtended cat)
    {
        categoryToDelete = cat;
        showDeleteConfirm = true;
    }
    private void CloseDeleteConfirm()
    {
        showDeleteConfirm = false;
        categoryToDelete = null;
    }
    private void OpenCreateModal()
    {
        isEdit = false;
        formCategoryID = 0;
        formName = string.Empty;
        formDescription = string.Empty;
        formIcon = string.Empty;
        showEditModal = true;
    }

    private async Task SaveCategoryAsync()
    {
        if (isSaving) return;
        // Basic validation
        if (string.IsNullOrWhiteSpace(formName))
        {
            Toast.Error("Tên danh mục bắt buộc");
            return;
        }
        isSaving = true;
        try
        {
            if (isEdit)
            {
                var req = new UpdateCategoryReq
                {
                    CategoryID = formCategoryID,
                    Name = formName.Trim(),
                    Description = string.IsNullOrWhiteSpace(formDescription) ? null : formDescription.Trim(),
                    Icon = formIcon?.Trim() ?? string.Empty
                };
                var res = await CategoryService.UpdateCategoryAsync(req);
                if (res.Success)
                {
                    Toast.Success(string.IsNullOrEmpty(res.Message) ? "Cập nhật danh mục thành công" : res.Message);
                    CloseEditModal();
                    await LoadCategories();
                }
                else
                {
                    Toast.Error(string.IsNullOrEmpty(res.Message) ? "Cập nhật thất bại" : res.Message);
                }
            }
            else
            {
                var req = new AddCategoryReq
                {
                    Name = formName.Trim(),
                    Description = string.IsNullOrWhiteSpace(formDescription) ? null : formDescription.Trim(),
                    Icon = formIcon?.Trim() ?? string.Empty
                };
                var res = await CategoryService.CreateCategoryAsync(req);
                if (res.Success)
                {
                    Toast.Success(string.IsNullOrEmpty(res.Message) ? "Thêm danh mục thành công" : res.Message);
                    CloseEditModal();
                    // Sau khi thêm quay về trang 1 để dễ thấy mục mới
                    currentPage = 1;
                    await LoadCategories();
                }
                else
                {
                    Toast.Error(string.IsNullOrEmpty(res.Message) ? "Thêm thất bại" : res.Message);
                }
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"Lỗi: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteCategoryAsync()
    {
        if (isSaving || categoryToDelete == null) return;
        isSaving = true;
        try
        {
            var req = new RemoveCategoryReq { CategoryID = categoryToDelete.CategoryID };
            var res = await CategoryService.RemoveCategoryAsync(req);
            if (res.Success)
            {
                Toast.Success(string.IsNullOrEmpty(res.Message) ? "Xóa danh mục thành công" : res.Message);
                CloseDeleteConfirm();
                await LoadCategories();
            }
            else
            {
                Toast.Error(string.IsNullOrEmpty(res.Message) ? "Xóa thất bại" : res.Message);
            }
        }
        catch (Exception ex)
        {
            Toast.Error($"Lỗi: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
}
