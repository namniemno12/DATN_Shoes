@using WebUI.Models

<!-- Product Details Component -->
<div class="product-details">
    <!-- Product Name & Brand -->
    <div class="product-header">
        <div class="product-brand">@Product.Brand</div>
        <h1 class="product-name">@Product.Name</h1>
    </div>

    <!-- Product Rating -->
    <div class="product-rating">
        <div class="rating-stars">
            @for (int i = 1; i <= 5; i++)
            {
                <i class="fas fa-star @(i <= Product.Rating ? "filled" : "")"></i>
            }
        </div>
        <span class="rating-text">@Product.Rating.ToString("F1") (@Product.ReviewCount reviews)</span>
        <a href="#reviews" class="rating-link">See all reviews</a>
    </div>

    <!-- Product Price -->
    <div class="product-pricing">
        <div class="price-main">
            <span class="current-price">@GetCurrentPriceFormatted()</span>
            @if (Product.OriginalPrice.HasValue)
            {
                <span class="old-price">@Product.OldPriceFormatted</span>
            }
            @if (Product.HasDiscount)
            {
                <span class="discount-badge">@Product.Discount</span>
            }
        </div>
        @if (Product.HasDiscount)
        {
            <div class="savings-info">
                <i class="fas fa-tag"></i>
                <span>You save: @GetSavingsAmount()</span>
            </div>
        }
    </div>

    <!-- Product Short Description -->
    <div class="product-description">
        <p>@GetShortDescription()</p>
    </div>

    <!-- Product Options (Size, Color, etc.) -->
    <div class="product-options">
        <!-- Size Selection -->
        @if (AvailableSizes?.Any() == true)
        {
            <div class="option-group">
                <label class="option-label">
                    Size: 
                    @if (string.IsNullOrEmpty(SelectedSize))
                    {
                        <span style="color: red; font-size: 0.85em;">(Required)</span>
                    }
                    else if (!string.IsNullOrEmpty(SelectedColor))
                    {
                        var stock = GetStockForSizeAndColor(SelectedSize, SelectedColor);
                        if (stock > 0)
                        {
                            <span style="color: #059669; font-size: 0.85em; font-weight: 600; margin-left: 8px;">
                                (@stock còn lại)
                            </span>
                        }
                        else
                        {
                            <span style="color: #dc3545; font-size: 0.85em; font-weight: 600; margin-left: 8px;">
                                (Hết hàng)
                            </span>
                        }
                    }
                </label>
                <div class="size-options">
                    @foreach (var size in AvailableSizes)
                    {
                        var sizeValue = size;
                        var isSelected = !string.IsNullOrEmpty(SelectedSize) && SelectedSize.Equals(sizeValue, StringComparison.OrdinalIgnoreCase);
                        var buttonStyle = isSelected 
                            ? "min-width: 48px; height: 48px; padding: 0 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 700; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; background: linear-gradient(135deg, rgb(37, 99, 235) 0%, rgb(29, 78, 216) 100%); color: rgb(255, 255, 255); border: 2px solid rgb(37, 99, 235); box-shadow: rgba(37, 99, 235, 0.3) 0px 6px 16px; transform: translateY(-2px);"
                            : "min-width: 48px; height: 48px; padding: 0 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; background: rgb(255, 255, 255); color: rgb(73, 80, 87); border: 2px solid rgb(222, 226, 230);";
                        
                        @if (isSelected)
                        {
                            <text><!-- Selected: @sizeValue (SelectedSize=@SelectedSize) --></text>
                        }
                        
                        <button type="button"
                                style="@buttonStyle"
                                @onclick="@(() => SelectSize(sizeValue))">
                            @if (isSelected)
                            {
                                <i class="fas fa-check" style="margin-right: 4px; font-size: 12px;"></i>
                            }
                            @sizeValue
                        </button>
                    }
                </div>
                <a href="#size-guide" class="size-guide-link">Size Guide</a>
            </div>
        }

        <!-- Color Selection -->
        @if (AvailableColors?.Any() == true)
        {
            <div class="option-group">
                <label class="option-label">
                    Color: 
                    @if (string.IsNullOrEmpty(SelectedColor))
                    {
                        <span style="color: red; font-size: 0.85em;">(Required)</span>
                    }
                    else
                    {
                        var selectedColorInfo = Product.Colors?.FirstOrDefault(c => c.HexColor.Equals(SelectedColor, StringComparison.OrdinalIgnoreCase));
                        if (selectedColorInfo != null)
                        {
                            <span style="color: #059669; font-size: 0.85em; font-weight: 600; margin-left: 8px;">
                                (@selectedColorInfo.AvailableStock có sẵn)
                            </span>
                        }
                    }
                </label>
                <div class="color-options">
                    @foreach (var color in AvailableColors)
                    {
                        var colorHex = color.Value;
                        var colorStock = color.Stock;
                        var isOutOfStock = colorStock <= 0;
                        var isSelected = !string.IsNullOrEmpty(SelectedColor) && SelectedColor.Equals(colorHex, StringComparison.OrdinalIgnoreCase);
                        var borderStyle = isSelected 
                            ? "4px solid rgb(37, 99, 235)"
                            : (colorHex.ToUpper() == "#FFFFFF" ? "3px solid rgb(222, 226, 230)" : "3px solid transparent");
                        var boxShadowStyle = isSelected
                            ? "rgba(37, 99, 235, 0.4) 0px 6px 20px"
                            : "rgba(0, 0, 0, 0.1) 0px 2px 8px";
                        var transformStyle = isSelected ? "scale(1.15)" : "scale(1)";
                        var opacity = isOutOfStock ? "0.4" : "1";
                        var cursor = isOutOfStock ? "not-allowed" : "pointer";
                        var buttonStyle = $"width: 44px; height: 44px; border-radius: 50%; cursor: {cursor}; transition: all 0.3s ease; position: relative; display: flex; align-items: center; justify-content: center; background-color: {colorHex}; border: {borderStyle}; box-shadow: {boxShadowStyle}; transform: {transformStyle}; opacity: {opacity};";
                        
                        <div class="color-item" style="position: relative; display: flex; flex-direction: column; align-items: center;">
                            <button type="button"
                                    style="@buttonStyle"
                                    title="@(isOutOfStock ? $"{color.Name} - Hết hàng" : color.Name)"
                                    @onclick="@(() => !isOutOfStock ? SelectColor(colorHex) : Task.CompletedTask)"
                                    disabled="@isOutOfStock">
                                @if (isSelected)
                                {
                                    <i class="fas fa-check" 
                                       style="color: @(colorHex.ToUpper() == "#FFFFFF" || colorHex.ToUpper() == "#FFFF00" ? "#000" : "#fff"); font-size: 14px; font-weight: bold;"></i>
                                }
                                @if (isOutOfStock)
                                {
                                    <div style="position: absolute; width: 100%; height: 2px; background: #dc3545; transform: rotate(-45deg);"></div>
                                }
                            </button>
                            @if (isOutOfStock)
                            {
                                <span style="font-size: 10px; color: #dc3545; margin-top: 4px; font-weight: 600;">Hết hàng</span>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Quantity & Stock -->
    <div class="quantity-stock-section">
        <div class="quantity-selector">
            <label class="quantity-label">Quantity:</label>
            <div class="quantity-controls">
                <button class="qty-btn minus" @onclick="DecreaseQuantity" disabled="@(Quantity <= 1)">
                    <i class="fas fa-minus"></i>
                </button>
                <input type="number" @bind="Quantity" @bind:event="oninput" 
                       @onchange="OnQuantityInputChanged"
                       min="1" max="@Product.StockQuantity" class="qty-input" />
                <button class="qty-btn plus" @onclick="IncreaseQuantity" disabled="@(Quantity >= Product.StockQuantity)">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        
        <div class="stock-info">
            @if (Product.StockQuantity > 0)
            {
                <span class="stock-available">
                    <i class="fas fa-check-circle"></i>
                    @Product.StockQuantity in stock
                </span>
            }
            else
            {
                <span class="stock-out">
                    <i class="fas fa-times-circle"></i>
                    Out of stock
                </span>
            }
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="product-actions">
        @{
            var canAddToCart = Product.StockQuantity > 0 
                && !string.IsNullOrEmpty(SelectedSize) 
                && !string.IsNullOrEmpty(SelectedColor);
            var disabledReason = Product.StockQuantity == 0 ? "Out of stock" 
                : string.IsNullOrEmpty(SelectedSize) ? "Please select a size" 
                : string.IsNullOrEmpty(SelectedColor) ? "Please select a color"
                : "";
        }
        <button class="btn-add-cart @(!canAddToCart ? "disabled" : "")"
                @onclick="HandleAddToCart"
                disabled="@(!canAddToCart)"
                title="@disabledReason">
            <i class="fas fa-cart-plus"></i>
            <span>@(canAddToCart ? "Add to Cart" : disabledReason)</span>
        </button>
        
        <button class="btn-buy-now @(Product.StockQuantity == 0 ? "disabled" : "")"
                @onclick="HandleBuyNow"
                disabled="@(Product.StockQuantity == 0)">
            <i class="fas fa-bolt"></i>
            <span>Buy Now</span>
        </button>
        
        <button class="btn-wishlist @(IsInWishlist ? "active" : "")"
                @onclick="ToggleWishlist"
                title="@(IsInWishlist ? "Remove from Wishlist" : "Add to Wishlist")">
            <i class="@(IsInWishlist ? "fas" : "far") fa-heart"></i>
        </button>
    </div>



    <!-- Product Features from API -->
    @if (Product?.Features?.Any() == true)
    {
        <div class="product-highlights">
            <h4 class="highlights-title">Product Features</h4>
            <ul class="highlights-list">
                @foreach (var feature in Product.Features)
                {
                    <li class="highlight-item">
                        <i class="fas fa-check-circle"></i>
                        <span>@feature</span>
                    </li>
                }
            </ul>
        </div>
    }

    <!-- Service Features -->
    <div class="product-features">
        <div class="feature-item">
            <i class="fas fa-truck"></i>
            <div class="feature-text">
                <span class="feature-title">Free Delivery</span>
                <span class="feature-desc">On orders over $50</span>
            </div>
        </div>
        <div class="feature-item">
            <i class="fas fa-undo"></i>
            <div class="feature-text">
                <span class="feature-title">Easy Returns</span>
                <span class="feature-desc">30-day return policy</span>
            </div>
        </div>
        <div class="feature-item">
            <i class="fas fa-shield-alt"></i>
            <div class="feature-text">
                <span class="feature-title">Warranty</span>
                <span class="feature-desc">1-year warranty included</span>
            </div>
        </div>
        <div class="feature-item">
            <i class="fas fa-headset"></i>
            <div class="feature-text">
                <span class="feature-title">24/7 Support</span>
                <span class="feature-desc">Customer service</span>
            </div>
        </div>
    </div>

    <!-- Social Share -->
    <div class="social-share">
        <span class="share-label">Share:</span>
        <div class="share-buttons">
            <button class="share-btn facebook" @onclick='() => ShareProduct("facebook")' title="Share on Facebook">
                <i class="fab fa-facebook-f"></i>
            </button>
            <button class="share-btn twitter" @onclick='() => ShareProduct("twitter")' title="Share on Twitter">
                <i class="fab fa-twitter"></i>
            </button>
            <button class="share-btn pinterest" @onclick='() => ShareProduct("pinterest")' title="Share on Pinterest">
                <i class="fab fa-pinterest"></i>
            </button>
            <button class="share-btn copy" @onclick="CopyProductLink" title="Copy Link">
                <i class="fas fa-link"></i>
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public Product Product { get; set; } = new();
    [Parameter] public EventCallback<int> OnQuantityChanged { get; set; }
    [Parameter] public EventCallback OnAddToCart { get; set; }
    [Parameter] public EventCallback OnBuyNow { get; set; }
    [Parameter] public EventCallback<string> OnSizeChanged { get; set; }
    [Parameter] public EventCallback<string> OnColorChanged { get; set; }
    
    // Parameters for initial values from parent
    [Parameter] public int InitialQuantity { get; set; } = 1;
    [Parameter] public string InitialSize { get; set; } = "";
    [Parameter] public string InitialColor { get; set; } = "";

    // Component State - sync with parent via parameters
    private int Quantity { get; set; } = 1;
    private string SelectedSize { get; set; } = "";
    private string SelectedColor { get; set; } = "";
    private bool IsInWishlist { get; set; } = false;
    private bool _initialized = false;

    // Available Options (will be populated from Product data)
    private List<string> AvailableSizes { get; set; } = new();
    private List<(string Name, string Value, int Stock)> AvailableColors { get; set; } = new();

    protected override void OnParametersSet()
    {
        if (Product != null && !string.IsNullOrEmpty(Product.Name))
        {
            AvailableSizes = Product.Sizes ?? new List<string>();
            AvailableColors = (Product.Colors ?? new List<ColorInfo>())
                .Select(c => (c.ColorName, c.HexColor, c.AvailableStock))
                .ToList();
            
            // Only set initial values on first load, don't reset user selections
            if (!_initialized)
            {
                Quantity = InitialQuantity > 0 ? InitialQuantity : 1;
                SelectedSize = InitialSize ?? "";
                SelectedColor = InitialColor ?? "";
                _initialized = true;
            }
        }
    }

    private string GetShortDescription()
    {
        return Product.Description;
    }

    private decimal GetCurrentPrice()
    {
        // If both color and size are selected, get the specific variant price
        if (!string.IsNullOrEmpty(SelectedColor) && !string.IsNullOrEmpty(SelectedSize))
        {
            var colorInfo = Product.Colors?.FirstOrDefault(c => c.HexColor.Equals(SelectedColor, StringComparison.OrdinalIgnoreCase));
            if (colorInfo?.SizePrice != null && colorInfo.SizePrice.TryGetValue(SelectedSize, out decimal variantPrice))
            {
                return variantPrice;
            }
        }
        
        // Fall back to the product's default price (minimum price across all variants)
        return Product.Price;
    }

    private string GetCurrentPriceFormatted()
    {
        return $"{GetCurrentPrice():N0}đ";
    }

    private string GetSavingsAmount()
    {
        if (Product.OriginalPrice.HasValue)
        {
            var currentPrice = GetCurrentPrice();
            var savings = Product.OriginalPrice.Value - currentPrice;
            return savings.ToString("N0") + "đ";
        }
        return "";
    }

    private async Task SelectSize(string size)
    {
        Console.WriteLine($"SelectSize called: {size}");
        SelectedSize = size;
        Console.WriteLine($"SelectedSize set to: {SelectedSize}");
        StateHasChanged(); // Force UI update first
        await InvokeAsync(StateHasChanged); // Ensure UI updates on correct thread
        await OnSizeChanged.InvokeAsync(size);
    }

    private async Task SelectColor(string color)
    {
        Console.WriteLine($"SelectColor called: {color}");
        SelectedColor = color;
        Console.WriteLine($"SelectedColor set to: {SelectedColor}");
        StateHasChanged(); // Force UI update first
        await InvokeAsync(StateHasChanged); // Ensure UI updates on correct thread
        await OnColorChanged.InvokeAsync(SelectedColor);
    }

    private async Task IncreaseQuantity()
    {
        if (Quantity < Product.StockQuantity)
        {
            Quantity++;
            await OnQuantityChanged.InvokeAsync(Quantity);
        }
    }

    private async Task DecreaseQuantity()
    {
        if (Quantity > 1)
        {
            Quantity--;
            await OnQuantityChanged.InvokeAsync(Quantity);
        }
    }

    private async Task OnQuantityInputChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int newQuantity))
        {
            if (newQuantity >= 1 && newQuantity <= Product.StockQuantity)
            {
                Quantity = newQuantity;
                await OnQuantityChanged.InvokeAsync(Quantity);
            }
        }
    }

    private int GetStockForSizeAndColor(string size, string colorHex)
    {
        if (string.IsNullOrEmpty(size) || string.IsNullOrEmpty(colorHex))
            return 0;

        var colorInfo = Product.Colors?.FirstOrDefault(c => c.HexColor.Equals(colorHex, StringComparison.OrdinalIgnoreCase));
        if (colorInfo?.SizeStock != null && colorInfo.SizeStock.TryGetValue(size, out int stock))
        {
            return stock;
        }
        return 0;
    }

    private async Task HandleAddToCart()
    {
        await OnAddToCart.InvokeAsync();
    }

    private async Task HandleBuyNow()
    {
        await OnBuyNow.InvokeAsync();
    }

    private void ToggleWishlist()
    {
        IsInWishlist = !IsInWishlist;
        StateHasChanged();
    }

    private void ShareProduct(string platform)
    {
        // Share product on social media
    }

    private async Task CopyProductLink()
    {
        var url = $"https://abc-mart.com/product/{Product.Name.Replace(" ", "-").ToLower()}";
        // Copy link to clipboard
    }

}