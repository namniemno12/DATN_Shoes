@page "/order-detail/{orderId}"
@using WebUI.Models
@inject Services.OrderService OrderService
@inject Services.IToastService ToastService
@inject NavigationManager NavigationManager

<link rel="stylesheet" href="css/order-detail.css" />

<div class="container py-4 order-detail-page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button class="btn btn-link text-decoration-none px-0" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> Trở lại đơn hàng
            </button>
            <h3 class="fw-bold mb-0">Chi tiết đơn hàng</h3>
            @if (orderDetail != null)
            {
                <div class="text-muted mt-1">
                    Mã đơn: <span class="fw-semibold text-primary">@orderDetail.OrderCode</span>
                    <span class="ms-2">•</span>
                    Ngày đặt: @orderDetail.OrderDate.ToString("dd/MM/yyyy HH:mm")
                </div>
            }
        </div>
        @if (orderDetail != null)
        {
            <div class="d-flex gap-2 align-items-center">
                @GetStatusBadge(orderDetail.Status)
                @GetPaymentStatusBadge(orderDetail.PaymentStatus)
            </div>
        }
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2 text-muted">Đang tải chi tiết đơn hàng...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>@errorMessage
        </div>
    }
    else if (orderDetail != null)
    {
        <div class="row g-3">
            <div class="col-lg-8">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div class="text-muted">Trạng thái vận chuyển</div>
                                <div class="fw-semibold">@(!string.IsNullOrEmpty(orderDetail.ShippingProvider) ? orderDetail.ShippingProvider : "Chưa cập nhật")</div>
                            </div>
                            <div class="text-end">
                                <div class="text-muted">Mã vận đơn</div>
                                <div class="fw-semibold">@(!string.IsNullOrEmpty(orderDetail.TrackingNumber) ? orderDetail.TrackingNumber : "Chưa có")</div>
                                @if (orderDetail.ShippedDate.HasValue)
                                {
                                    <small class="text-muted">Giao ngày @orderDetail.ShippedDate.Value.ToString("dd/MM/yyyy")</small>
                                }
                            </div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-block">
                                <div class="detail-label">Khách hàng</div>
                                <div class="detail-value">@orderDetail.FullName</div>
                                <div class="detail-sub">@orderDetail.PhoneNumber</div>
                            </div>
                            <div class="detail-block">
                                <div class="detail-label">Thanh toán</div>
                                <div class="detail-value">@orderDetail.PaymentMethod</div>
                                <div class="detail-sub">@orderDetail.PaymentStatusText</div>
                            </div>
                            <div class="detail-block">
                                <div class="detail-label">Địa chỉ nhận</div>
                                <div class="detail-value">@(!string.IsNullOrEmpty(orderDetail.GhnFullAddress) ? orderDetail.GhnFullAddress : (!string.IsNullOrEmpty(orderDetail.Address) ? orderDetail.Address : "Chưa có địa chỉ"))</div>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(orderDetail.Note))
                        {
                            <div class="mt-3 alert alert-info mb-0">
                                <i class="bi bi-sticky me-2"></i>@orderDetail.Note
                            </div>
                        }
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Sản phẩm</h5>
                        @if (orderDetail.ListProduct.Any())
                        {
                            <div class="list-group list-group-flush">
                                @foreach (var item in orderDetail.ListProduct)
                                {
                                    <div class="list-group-item px-0 py-3 d-flex align-items-center">
                                        <img src="@item.ImageUrl" alt="@item.ProductName" class="rounded me-3" style="width:70px;height:70px;object-fit:cover;">
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold">@item.ProductName</div>
                                            <div class="text-muted small">@item.BrandName • Size: @item.Value</div>
                                            <div class="small text-muted">SL: @item.Quantity</div>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-semibold">@item.SellingPrice.ToString("N0") ₫</div>
                                            <div class="text-muted small">Tạm tính: @item.TotalPrice.ToString("N0") ₫</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-muted">Không có sản phẩm trong đơn hàng.</div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Tổng kết</h5>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính</span>
                            <span>@orderDetail.Subtotal.ToString("N0") ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí vận chuyển</span>
                            <span>@orderDetail.ShippingFee.ToString("N0") ₫</span>
                        </div>
                        @if (orderDetail.Discount > 0)
                        {
                            <div class="d-flex justify-content-between mb-2 text-success">
                                <span>Giảm giá</span>
                                <span>-@orderDetail.Discount.ToString("N0") ₫</span>
                            </div>
                        }
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>Tổng cộng</span>
                            <span class="text-danger">@orderDetail.TotalAmount.ToString("N0") ₫</span>
                        </div>
                        @if (!string.IsNullOrEmpty(orderDetail.VoucherCode))
                        {
                            <div class="mt-2 text-muted small">Voucher: @orderDetail.VoucherCode</div>
                        }
                        <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-outline-secondary" @onclick="GoBack">Quay lại danh sách</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string? orderId { get; set; }

    private GetOrderDetailRes? orderDetail;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDetailAsync();
    }

    private async Task LoadDetailAsync()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            if (string.IsNullOrWhiteSpace(orderId) || !int.TryParse(orderId, out var parsedId))
            {
                errorMessage = "Mã đơn hàng không hợp lệ.";
            }
            else
            {
                var result = await OrderService.GetOrderDetailAsync(parsedId);
                if (result.Success && result.Data != null)
                {
                    orderDetail = result.Data;
                }
                else
                {
                    errorMessage = result.Message ?? "Không tải được chi tiết đơn hàng.";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Có lỗi xảy ra: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private RenderFragment GetStatusBadge(int status) => status switch
    {
        0 => builder => builder.AddMarkupContent(0, "<span class='badge bg-warning text-dark'><i class='bi bi-clock me-1'></i>Chờ xử lý</span>"),
        1 => builder => builder.AddMarkupContent(0, "<span class='badge bg-primary'><i class='bi bi-check-circle me-1'></i>Đã xác nhận</span>"),
        2 => builder => builder.AddMarkupContent(0, "<span class='badge bg-info'><i class='bi bi-box-seam me-1'></i>Đang chuẩn bị</span>"),
        3 => builder => builder.AddMarkupContent(0, "<span class='badge bg-info'><i class='bi bi-truck me-1'></i>Đang giao</span>"),
        4 => builder => builder.AddMarkupContent(0, "<span class='badge bg-success'><i class='bi bi-check-circle-fill me-1'></i>Đã giao</span>"),
        5 => builder => builder.AddMarkupContent(0, "<span class='badge bg-danger'><i class='bi bi-x-circle me-1'></i>Đã hủy</span>"),
        _ => builder => builder.AddMarkupContent(0, "<span class='badge bg-secondary'>Không xác định</span>")
    };

    private RenderFragment GetPaymentStatusBadge(int status) => status switch
    {
        1 => builder => builder.AddMarkupContent(0, "<span class='badge bg-success'>Đã thanh toán</span>"),
        0 => builder => builder.AddMarkupContent(0, "<span class='badge bg-warning text-dark'>Chờ thanh toán</span>"),
        3 => builder => builder.AddMarkupContent(0, "<span class='badge bg-danger'>Thất bại</span>"),
        2 => builder => builder.AddMarkupContent(0, "<span class='badge bg-info'>Đã hoàn tiền</span>"),
        _ => builder => builder.AddMarkupContent(0, "<span class='badge bg-secondary'>Chưa thanh toán</span>")
    };

    private void GoBack()
    {
        NavigationManager.NavigateTo("/orders");
    }
}
