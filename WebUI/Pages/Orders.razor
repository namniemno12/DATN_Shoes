@page "/orders"
@using System.Linq
@inject Services.OrderService OrderService
@inject Services.Interfaces.IAuthService AuthService
@inject Services.IToastService ToastService
@inject NavigationManager NavigationManager

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold mb-3">
                <i class="bi bi-box-seam me-2"></i>Quản lý đơn hàng
            </h2>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "all" ? "active" : "")" 
                    @onclick='() => SetActiveTab("all")'>
                Tất cả <span class="badge bg-secondary ms-1">@allOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "unpaid" ? "active" : "")" 
                    @onclick='() => SetActiveTab("unpaid")'>
                Chưa thanh toán <span class="badge bg-danger ms-1">@unpaidOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "pending" ? "active" : "")" 
                    @onclick='() => SetActiveTab("pending")'>
                Chờ xử lý <span class="badge bg-warning text-dark ms-1">@pendingOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "shipping" ? "active" : "")" 
                    @onclick='() => SetActiveTab("shipping")'>
                Đang giao <span class="badge bg-info ms-1">@shippingOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "delivered" ? "active" : "")" 
                    @onclick='() => SetActiveTab("delivered")'>
                Đã giao <span class="badge bg-success ms-1">@deliveredOrders.Count</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "cancelled" ? "active" : "")" 
                    @onclick='() => SetActiveTab("cancelled")'>
                Đã hủy <span class="badge bg-danger ms-1">@cancelledOrders.Count</span>
            </button>
        </li>
    </ul>

    <!-- Search and Filter -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" class="form-control" placeholder="Tìm kiếm theo mã đơn, tên khách hàng..." 
                       @bind="searchText" @bind:event="oninput">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="sortBy">
                <option value="newest">Mới nhất</option>
                <option value="oldest">Cũ nhất</option>
                <option value="highest">Giá cao nhất</option>
                <option value="lowest">Giá thấp nhất</option>
            </select>
        </div>
    </div>

    <!-- Orders List -->
    <div class="row">
        @if (isLoading)
        {
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-2 text-muted">Đang tải đơn hàng...</p>
            </div>
        }
        else if (FilteredOrders.Any())
        {
            @foreach (var order in FilteredOrders)
            {
                <div class="col-12 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-header bg-white border-bottom">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong>Mã đơn:</strong> <span class="text-primary">@order.OrderNumber</span>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar3 me-1"></i>@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                                <div class="col-md-4 text-end">
                                    @GetStatusBadge(order.Status)
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <!-- Customer Info -->
                                    <div class="mb-3">
                                        <h6 class="mb-2"><i class="bi bi-person me-2"></i>Thông tin khách hàng</h6>
                                        <p class="mb-1"><strong>Tên:</strong> @order.ReceiverName</p>
                                        <p class="mb-1"><strong>SĐT:</strong> @order.ReceiverPhone</p>
                                        <p class="mb-1"><strong>Email:</strong> @order.ReceiverEmail</p>
                                        <p class="mb-1"><strong>Địa chỉ:</strong> @order.FullAddress</p>
                                    </div>

                                    <!-- Order Items -->
                                    <div class="mb-3">
                                        <h6 class="mb-2"><i class="bi bi-bag me-2"></i>Sản phẩm</h6>
                                        @foreach (var item in order.Items)
                                        {
                                            <div class="d-flex align-items-center mb-2 p-2 border rounded">
                                                <img src="@item.ImageUrl" alt="@item.ProductName" 
                                                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                                <div class="flex-grow-1">
                                                    <p class="mb-0 fw-semibold">@item.ProductName</p>
                                                    <small class="text-muted">
                                                        @if (!string.IsNullOrEmpty(item.SelectedSize))
                                                        {
                                                            <span>Size: @item.SelectedSize</span>
                                                        }
                                                        @if (!string.IsNullOrEmpty(item.SelectedColor))
                                                        {
                                                            <span class="ms-2">Màu: @item.SelectedColor</span>
                                                        }
                                                    </small>
                                                    <p class="mb-0 mt-1">
                                                        <span class="text-muted">x@item.Quantity</span>
                                                        <span class="ms-2 fw-semibold">@item.Price.ToString("N0") ₫</span>
                                                    </p>
                                                </div>
                                                <div class="text-end">
                                                    <strong>@item.TotalPrice.ToString("N0") ₫</strong>
                                                </div>
                                            </div>
                                        }
                                    </div>

                                    @if (!string.IsNullOrEmpty(order.Note))
                                    {
                                        <div class="alert alert-info mb-0">
                                            <i class="bi bi-sticky me-2"></i><strong>Ghi chú:</strong> @order.Note
                                        </div>
                                    }
                                </div>

                                <div class="col-md-4">
                                    <!-- Order Summary -->
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="mb-3">Tóm tắt đơn hàng</h6>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Tạm tính:</span>
                                                <span>@order.SubTotal.ToString("N0") ₫</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Phí vận chuyển:</span>
                                                <span>@order.ShippingFee.ToString("N0") ₫</span>
                                            </div>
                                            @if (order.Discount > 0)
                                            {
                                                <div class="d-flex justify-content-between mb-2 text-success">
                                                    <span>Giảm giá:</span>
                                                    <span>-@order.Discount.ToString("N0") ₫</span>
                                                </div>
                                            }
                                            <hr>
                                            <div class="d-flex justify-content-between fw-bold fs-5">
                                                <span>Tổng cộng:</span>
                                                <span class="text-danger">@order.TotalAmount.ToString("N0") ₫</span>
                                            </div>
                                            <div class="mt-3">
                                                <small class="text-muted">
                                                    <i class="bi bi-credit-card me-1"></i>@GetPaymentMethodText(order.PaymentMethod)
                                                </small>
                                                <br>
                                                <small class="text-muted">
                                                    Trạng thái: @GetPaymentStatusBadge(order.PaymentStatus)
                                                </small>
                                            </div>

                                            <!-- GHN Tracking -->
                                            @if (!string.IsNullOrEmpty(order.GhnOrderCode))
                                            {
                                                <div class="mt-3 border-top pt-3">
                                                    <h6 class="mb-2">
                                                        <i class="bi bi-truck me-2"></i>Vận chuyển GHN
                                                    </h6>
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block">Mã vận đơn</small>
                                                        <code class="text-danger fw-bold">@order.GhnOrderCode</code>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(order.GhnStatus))
                                                    {
                                                        <div class="mb-2">
                                                            <small class="text-muted d-block">Trạng thái</small>
                                                            @GetGhnStatusBadge(order.GhnStatus)
                                                        </div>
                                                    }
                                                    @if (order.GhnFee.HasValue)
                                                    {
                                                        <div class="mb-2">
                                                            <small class="text-muted d-block">Phí ship GHN</small>
                                                            <strong class="text-success">@order.GhnFee.Value.ToString("N0") ₫</strong>
                                                        </div>
                                                    }
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block">COD</small>
                                                        <span class="badge @(order.CodCollected ? "bg-success" : "bg-warning")">
                                                            @(order.CodCollected ? "Đã thu" : "Chưa thu")
                                                        </span>
                                                    </div>
                                                    <a href="https://donhang.ghn.vn/?order_code=@order.GhnOrderCode" 
                                                       target="_blank" 
                                                       class="btn btn-sm btn-outline-danger w-100">
                                                        <i class="bi bi-box-arrow-up-right me-1"></i>Xem trên GHN
                                                    </a>
                                                </div>
                                            }

                                            <!-- Actions -->
                                            <div class="mt-3 d-grid gap-2">
                                                @if (activeTab == "unpaid" && order.Status == 0 && order.PaymentMethod != 1)
                                                {
                                                    var timeRemaining = GetTimeRemaining(order.CreatedAt);
                                                    var isUrgent = timeRemaining.TotalHours < 2;
                                                    <div class="alert @(isUrgent ? "alert-danger" : "alert-warning") p-2 mb-2">
                                                        <div class="d-flex align-items-center">
                                                            <i class="bi bi-clock me-2"></i>
                                                            <div class="flex-grow-1">
                                                                <small class="fw-bold">Thời gian còn lại:</small>
                                                                <div class="@(isUrgent ? "text-danger" : "") fw-bold">
                                                                    @FormatTimeRemaining(timeRemaining)
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button class="btn btn-danger btn-sm" 
                                                            @onclick="() => PayNowOrder(order.OrderId)">
                                                        <i class="bi bi-credit-card me-1"></i>Thanh toán ngay
                                                    </button>
                                                }
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        @onclick="() => ViewOrderDetail(order.OrderId)">
                                                    <i class="bi bi-eye me-1"></i>Chi tiết
                                                </button>
                                                @if (order.Status == 0 || order.Status == 1)
                                                {
                                                    <button class="btn btn-outline-danger btn-sm" 
                                                            @onclick="() => CancelOrder(order.OrderId)">
                                                        <i class="bi bi-x-circle me-1"></i>Hủy đơn
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    <p class="mb-0">Không có đơn hàng nào</p>
                </div>
            </div>
        }
    </div>
</div>

<ToastNotification />

@code {
    private string activeTab = "all";
    private string searchText = "";
    private string sortBy = "newest";
    private bool isLoading = false;
    private int currentPage = 1;
    private int recordPerPage = 10;
    private int totalRecords = 0;

    private List<GetOrderRes> allOrders = new();
    private List<GetOrderRes> unpaidOrders => allOrders.Where(o => 
        o.Status == 0 && 
        o.PaymentMethod != 1 && // Not COD
        (DateTime.Now - o.CreatedAt).TotalHours < 24 // Within 24 hours
    ).ToList();
    private List<GetOrderRes> pendingOrders => allOrders.Where(o => o.Status == 0).ToList();
    private List<GetOrderRes> shippingOrders => allOrders.Where(o => o.Status == 2 || o.Status == 3).ToList(); // Processing or Shipped
    private List<GetOrderRes> deliveredOrders => allOrders.Where(o => o.Status == 4).ToList();
    private List<GetOrderRes> cancelledOrders => allOrders.Where(o => o.Status == 5).ToList();

    private List<GetOrderRes> FilteredOrders
    {
        get
        {
            var orders = activeTab switch
            {
                "unpaid" => unpaidOrders,
                "pending" => pendingOrders,
                "shipping" => shippingOrders,
                "delivered" => deliveredOrders,
                "cancelled" => cancelledOrders,
                _ => allOrders
            };

            // Search filter
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                orders = orders.Where(o => 
                    o.OrderNumber.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    o.ReceiverName.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
                    o.ReceiverPhone.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                ).ToList();
            }

            // Sort
            orders = sortBy switch
            {
                "oldest" => orders.OrderBy(o => o.CreatedAt).ToList(),
                "highest" => orders.OrderByDescending(o => o.TotalAmount).ToList(),
                "lowest" => orders.OrderBy(o => o.TotalAmount).ToList(),
                _ => orders.OrderByDescending(o => o.CreatedAt).ToList()
            };

            return orders;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await AuthService.InitializeAsync();
        await LoadOrdersAsync();
    }

    private async Task LoadOrdersAsync()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var result = await OrderService.GetListOrderByUserAsync(currentPage, recordPerPage);
            
            if (result.Success && result.Data != null)
            {
                allOrders = result.Data;
                totalRecords = result.TotalRecord;
            }
            else
            {
                allOrders = new List<GetOrderRes>();
            }
        }
        catch (Exception)
        {
            allOrders = new List<GetOrderRes>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private string GetStatusText(int status)
    {
        return status switch
        {
            0 => "pending",
            1 => "confirmed",
            2 => "shipping",
            3 => "delivered",
            4 => "cancelled",
            _ => "unknown"
        };
    }

    private MarkupString GetStatusBadge(int status)
    {
        return status switch
        {
            0 => new MarkupString("<span class='badge bg-warning text-dark'><i class='bi bi-clock me-1'></i>Chờ xử lý</span>"),
            1 => new MarkupString("<span class='badge bg-primary'><i class='bi bi-check-circle me-1'></i>Đã xác nhận</span>"),
            2 => new MarkupString("<span class='badge bg-info'><i class='bi bi-box-seam me-1'></i>Đang chuẩn bị</span>"),
            3 => new MarkupString("<span class='badge bg-info'><i class='bi bi-truck me-1'></i>Đang giao</span>"),
            4 => new MarkupString("<span class='badge bg-success'><i class='bi bi-check-circle-fill me-1'></i>Đã giao</span>"),
            5 => new MarkupString("<span class='badge bg-danger'><i class='bi bi-x-circle me-1'></i>Đã hủy</span>"),
            _ => new MarkupString("<span class='badge bg-secondary'>Không xác định</span>")
        };
    }

    private MarkupString GetPaymentStatusBadge(int status)
    {
        return status switch
        {
            1 => new MarkupString("<span class='badge bg-success'>Đã thanh toán</span>"),
            0 => new MarkupString("<span class='badge bg-warning text-dark'>Chờ thanh toán</span>"),
            3 => new MarkupString("<span class='badge bg-danger'>Thất bại</span>"),
            2 => new MarkupString("<span class='badge bg-info'>Đã hoàn tiền</span>"),
            _ => new MarkupString("<span class='badge bg-secondary'>Chưa thanh toán</span>")
        };
    }

    private string GetPaymentMethodText(int method)
    {
        return method switch
        {
            1 => "Thanh toán khi nhận hàng (COD)",
            2 => "VNPay",
            3 => "PayPal",
            4 => "Google Pay",
            _ => "Không xác định"
        };
    }

    private MarkupString GetGhnStatusBadge(string? status)
    {
        return status?.ToLower() switch
        {
            "pending" => new MarkupString("<span class='badge bg-warning text-dark'><i class='bi bi-clock me-1'></i>Chờ lấy hàng</span>"),
            "picking" => new MarkupString("<span class='badge bg-info'><i class='bi bi-box-seam me-1'></i>Đang lấy hàng</span>"),
            "delivering" => new MarkupString("<span class='badge bg-primary'><i class='bi bi-truck me-1'></i>Đang giao hàng</span>"),
            "delivered" => new MarkupString("<span class='badge bg-success'><i class='bi bi-check-circle-fill me-1'></i>Đã giao</span>"),
            "return" => new MarkupString("<span class='badge bg-danger'><i class='bi bi-arrow-return-left me-1'></i>Hoàn trả</span>"),
            "cancel" => new MarkupString("<span class='badge bg-secondary'><i class='bi bi-x-circle me-1'></i>Đã hủy</span>"),
            _ => new MarkupString("<span class='badge bg-secondary'>Chưa gửi</span>")
        };
    }

    private void ViewOrderDetail(string orderId)
    {
        NavigationManager.NavigateTo($"/order-detail/{orderId}");
    }

    private async Task CancelOrder(string orderId)
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var order = allOrders.FirstOrDefault(o => o.OrderId == orderId);
            if (order == null) return;

            if (!int.TryParse(orderId, out int orderIdInt))
            {
                Console.WriteLine($"Invalid OrderId: {orderId}");
                return;
            }

            // Call API to update status to Cancelled (5)
            var result = await OrderService.UpdateOrderStatusAsync(orderIdInt, 5);

            if (result.Success)
            {
                order.Status = 5; // Update local state
                ToastService.ShowSuccess("Đã hủy đơn hàng thành công");
                StateHasChanged();
            }
            else
            {
                // Reload orders to get latest status from server
                await LoadOrdersAsync();
                ToastService.ShowError(result.Message ?? "Không thể hủy đơn hàng. Vui lòng tải lại trang.");
                Console.WriteLine($"Failed to cancel order: {result.Message}");
            }
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private TimeSpan GetTimeRemaining(DateTime createdAt)
    {
        var elapsed = DateTime.Now - createdAt;
        var remaining = TimeSpan.FromHours(24) - elapsed;
        return remaining > TimeSpan.Zero ? remaining : TimeSpan.Zero;
    }

    private string FormatTimeRemaining(TimeSpan timeRemaining)
    {
        if (timeRemaining.TotalSeconds <= 0)
            return "Đã hết hạn";
        
        if (timeRemaining.TotalHours >= 1)
            return $"{(int)timeRemaining.TotalHours} giờ {timeRemaining.Minutes} phút";
        
        return $"{timeRemaining.Minutes} phút";
    }

    private void PayNowOrder(string orderId)
    {
        NavigationManager.NavigateTo($"/payment/{orderId}");
    }
}