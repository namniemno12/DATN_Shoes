@page "/payment/{OrderId?}"
@using WebUI.Models
@using WebUI.Services
@using WebUI.Services.Interfaces
@inject OrderService OrderService
@inject IPaymentService PaymentService
@inject CartService CartService
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject IToastService ToastService
@inject IJSRuntime JSRuntime

@* Unified minimal theme styles are in asion.css *@

<div class="payment-page">
    <div class="payment-container">
        <!-- Back Link -->
        <a href="/checkout" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Quay l·∫°i th√¥ng tin giao h√†ng
        </a>

        <div class="payment-header">
            <h1 class="payment-title">Thanh to√°n</h1>
        </div>

        <!-- Progress Steps -->
        @if (IsProcessing)
        {
            <div class="payment-status processing">
                <div class="payment-status-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <h2 class="payment-status-title">ƒêang x·ª≠ l√Ω thanh to√°n...</h2>
                <p class="payment-status-message">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
            </div>
        }
        else if (PaymentStatus == "success")
        {
            <div class="payment-status success">
                <div class="payment-status-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="payment-status-title">Thanh to√°n th√†nh c√¥ng!</h2>
                <p class="payment-status-message">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n</p>
                <button class="btn-complete" @onclick='() => Navigation.NavigateTo("/")'>
                    <i class="fas fa-home"></i>
                    Tr·ªü v·ªÅ trang ch·ªß
                </button>
            </div>
        }
        else if (PaymentStatus == "failed")
        {
            <div class="payment-status failed">
                <div class="payment-status-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h2 class="payment-status-title">Thanh to√°n th·∫•t b·∫°i</h2>
                <p class="payment-status-message">Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n kh√°c</p>
                <button class="btn-continue" @onclick='() => PaymentStatus = ""'>
                    <i class="fas fa-redo"></i>
                    Th·ª≠ l·∫°i
                </button>
            </div>
    }
    else
        {
            <div style="display: flex; flex-direction: column; gap: 24px; max-width: 800px; margin: 0 auto;">
                <!-- Payment Details -->
                <div class="payment-methods-section">
                    <!-- Shipping Info Card -->
                    <div class="shipping-info-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 class="info-title">
                                <i class="fas fa-shipping-fast"></i>
                                Th√¥ng tin giao h√†ng
                            </h3>
                            <button class="btn-edit" @onclick='() => Navigation.NavigateTo("/checkout")'>
                                <i class="fas fa-edit"></i> S·ª≠a
                            </button>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ng∆∞·ªùi nh·∫≠n:</span>
                            <span class="info-value">@ReceiverName</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="info-value">@ReceiverPhone</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ƒê·ªãa ch·ªâ:</span>
                            <span class="info-value">@ShippingAddress</span>
                        </div>
                    </div>

                    <!-- Order Items Card -->
                    <div class="order-items-card">
                        <h3>S·∫£n ph·∫©m ƒë√£ ch·ªçn</h3>
                        <div class="order-items-list">
                            @if (CartService.CheckoutInfo?.SelectedApiItems?.Any() == true)
                            {
                                @foreach (var i in CartService.CheckoutInfo.SelectedApiItems)
                                {
                                    <div class="order-item-row">
                                        <img src="@i.ImageUrl" class="order-item-thumb" />
                                        <div style="flex:1; min-width:0;">
                                            <p class="order-item-name">@i.ProductName</p>
                                            <div class="order-item-meta">Size: @i.Size ‚Ä¢ @i.Color √ó @i.Quantity</div>
                                        </div>
                                        <div style="font-weight:800;">@i.TotalPriceFormatted</div>
                                    </div>
                                }
                            }
                            else if (CartService.CheckoutInfo?.SelectedLocalItems?.Any() == true)
                            {
                                @foreach (var i in CartService.CheckoutInfo.SelectedLocalItems)
                                {
                                    <div class="order-item-row">
                                        <img src="@i.Product.ImageUrl" class="order-item-thumb" />
                                        <div style="flex:1; min-width:0;">
                                            <p class="order-item-name">@i.Product.Name</p>
                                            <div class="order-item-meta">@((!string.IsNullOrEmpty(i.SelectedSize)?$"Size: {i.SelectedSize} ‚Ä¢ ":""))@((!string.IsNullOrEmpty(i.SelectedColor)?$"{i.SelectedColor} ‚Ä¢ ":""))√ó @i.Quantity</div>
                                        </div>
                                        <div style="font-weight:800;">@((i.Product.Price * i.Quantity).ToString("N0"))ƒë</div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div>Kh√¥ng c√≥ s·∫£n ph·∫©m ƒë∆∞·ª£c ch·ªçn.</div>
                            }
                        </div>
                    </div>

                    <!-- Payment Method Selection -->
                    <div class="payment-card">
                        <h2 class="card-title">
                            <i class="fas fa-credit-card card-icon"></i>
                            Ph∆∞∆°ng th·ª©c thanh to√°n
                        </h2>

                        <div class="payment-options">
                            <!-- COD -->
                            <div class="payment-option @(SelectedPaymentMethod == "cod" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "cod"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üíµ</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                    <div class="payment-method-description">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                                </div>
                                <div class="payment-fee">+15.000ƒë</div>
                            </div>
                            <!-- VNPay -->
                            <div class="payment-option @(SelectedPaymentMethod == "vnpay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "vnpay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üåê</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Thanh to√°n qua VNPay</div>
                                    <div class="payment-method-description">Thanh to√°n online qua c·ªïng VNPay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            <!-- Google Pay -->
                            <div class="payment-option @(SelectedPaymentMethod == "gpay" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "gpay"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper">üì≤</div>
                                <div class="payment-info">
                                    <div class="payment-method-name">Google Pay</div>
                                    <div class="payment-method-description">Thanh to√°n nhanh ch√≥ng v·ªõi Google Pay</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>

                            <!-- PayPal -->
                            <div class="payment-option @(SelectedPaymentMethod == "paypal" ? "selected" : "")"
                                 @onclick='() => SelectedPaymentMethod = "paypal"'>
                                <div class="payment-radio"></div>
                                <div class="payment-icon-wrapper"><i class="fab fa-paypal"></i></div>
                                <div class="payment-info">
                                    <div class="payment-method-name">PayPal</div>
                                    <div class="payment-method-description">Thanh to√°n qu·ªëc t·∫ø qua PayPal</div>
                                </div>
                                <div class="payment-fee">Mi·ªÖn ph√≠</div>
                            </div>
                            @if (SelectedPaymentMethod == "paypal")
                            {
                                <div class="payment-details">
                                    <div id="paypal-button-container" style="max-width:350px;margin:20px auto;"></div>
                                </div>
                            }
@code {
    // ...existing code...

    private async Task ShowGooglePay()
    {
        // Nh√∫ng Google Pay JS SDK qua JSInterop
        var amount = GetFinalTotalAmount();
        await JSRuntime.InvokeVoidAsync("eval", $@"
            (function() {{
                if (!window.google || !window.google.payments) {{
                    alert('Google Pay SDK ch∆∞a s·∫µn s√†ng!');
                    return;
                }}
                var paymentsClient = new google.payments.api.PaymentsClient({{ environment: 'TEST' }});
                var baseRequest = {{ apiVersion: 2, apiVersionMinor: 0 }};
                var allowedCardNetworks = ['VISA', 'MASTERCARD'];
                var allowedAuthMethods = ['PAN_ONLY', 'CRYPTOGRAM_3DS'];
                var tokenizationSpec = {{
                    type: 'PAYMENT_GATEWAY',
                    parameters: {{
                        gateway: 'stripe',
                        'stripe:version': '2020-08-27',
                        'stripe:publishableKey': 'pk_test_51SSDaCQvdo5RfVd5QXPLYoKsDjU0UuUo3qgvNBuPptjgUm9f8x43P636jLPVD1wWXPTX4pUYKy3rMawui9EsDSgV00hfGDVemy'
                    }}
                }};
                var cardPaymentMethod = {{
                    type: 'CARD',
                    parameters: {{
                        allowedAuthMethods: allowedAuthMethods,
                        allowedCardNetworks: allowedCardNetworks,
                        billingAddressRequired: true,
                        billingAddressParameters: {{ format: 'FULL' }}
                    }},
                    tokenizationSpecification: tokenizationSpec
                }};
                var paymentDataRequest = {{
                    apiVersion: 2,
                    apiVersionMinor: 0,
                    allowedPaymentMethods: [cardPaymentMethod],
                    transactionInfo: {{
                        totalPriceStatus: 'FINAL',
                        totalPrice: '{amount}',
                        currencyCode: 'USD',
                        countryCode: 'US'
                    }},
                    merchantInfo: {{ merchantName: 'Asion Store' }}
                }};
                paymentsClient.loadPaymentData(paymentDataRequest)
                    .then(function(paymentData) {{
                        var token = paymentData.paymentMethodData.tokenizationData.token;
                        if (window.DotNet && window.DotNet.invokeMethodAsync) {{
                            window.DotNet.invokeMethodAsync('WebUI', 'ReceiveGPayToken', token);
                        }}
                    }})
                    .catch(function(err) {{
                        alert('‚ùå L·ªói Google Pay: ' + err);
                    }});
            }})();
        ");
    }
}

                        </div>
                    </div>

                </div>

                <!-- Order Summary -->
                <div class="summary-card" style="max-width: 100%;">
                    <h3 class="summary-header">T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                    <div class="summary-divider"></div>
                    <div class="summary-row">
                        <span class="summary-label">T·∫°m t√≠nh</span>
                        <span class="summary-value">@SubTotal.ToString("N0")ƒë</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <span class="summary-value">@ShippingFee.ToString("N0")ƒë</span>
                    </div>
                    @if (Discount > 0)
                    {
                        <div class="summary-row discount">
                            <span class="summary-label">Gi·∫£m gi√°</span>
                            <span class="summary-value">-@Discount.ToString("N0")ƒë</span>
                        </div>
                    }
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span class="summary-label">T·ªïng c·ªông</span>
                        <span class="summary-value">@GetFinalTotal()</span>
                    </div>
                    <div class="terms-section">
                        <input type="checkbox" class="terms-checkbox" @bind="AgreeTerms" id="agreeTerms" />
                        <label for="agreeTerms" class="terms-text">
                            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#" class="terms-link">ƒêi·ªÅu kho·∫£n & ƒêi·ªÅu ki·ªán</a> c·ªßa Asion
                        </label>
                    </div>
                    <div class="payment-actions">
                        <button class="btn btn-primary" @onclick="OnPayClicked">Thanh to√°n</button>
                    </div>
                    <div class="security-badge">
                        <i class="fas fa-shield-alt security-icon"></i>
                        <span>Giao d·ªãch b·∫£o m·∫≠t SSL</span>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public string? OrderId { get; set; }

    private string OrderNumber = DateTime.Now.Ticks.ToString().Substring(8);
    private string ReceiverName = string.Empty;
    private string ReceiverPhone = string.Empty;
    private string ShippingAddress = string.Empty;
    
    private string SelectedPaymentMethod = "cod";
    private bool PayPalButtonRendered = false;
    private bool AgreeTerms = false;
    private bool IsProcessing = false;
    private string PaymentStatus = ""; // "", "processing", "success", "failed"
    private int? CreatedOrderId;
    private decimal SubTotal => CartService.CheckoutInfo?.Subtotal ?? 0;
    private decimal ShippingFee => CartService.CheckoutInfo?.ShippingFee ?? 0;
    private decimal Discount => CartService.CheckoutInfo?.Discount ?? 0;

    protected override void OnInitialized()
    {
        // L·∫•y th√¥ng tin t·ª´ Checkout
        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            // N·∫øu kh√¥ng c√≥ th√¥ng tin checkout, quay l·∫°i trang checkout
            Navigation.NavigateTo("/checkout");
            return;
        }

        ReceiverName = checkoutInfo.FullName;
        ReceiverPhone = checkoutInfo.Phone;
        ShippingAddress = $"{checkoutInfo.Address}, {checkoutInfo.City}";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (SelectedPaymentMethod == "paypal" && !PayPalButtonRendered)
        {
            PayPalButtonRendered = true;
            await RenderPayPalButton();
        }
        else if (SelectedPaymentMethod != "paypal")
        {
            PayPalButtonRendered = false;
        }
    }

    /// <summary>
    /// ƒê·∫£m b·∫£o order ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc khi x·ª≠ l√Ω thanh to√°n. Tr·∫£ v·ªÅ OrderID n·∫øu th√†nh c√¥ng.
    /// </summary>
    private async Task<int?> EnsureOrderCreated(string paymentMethod)
    {
        if (CreatedOrderId != null && CreatedOrderId > 0)
        {
            return CreatedOrderId;
        }

        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            await ToastService.ShowError("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng quay l·∫°i trang checkout.");
            Navigation.NavigateTo("/checkout");
            return null;
        }

        var orderRequest = new CreateOrderRequest
        {
            UserID = AuthService.IsAuthenticated ? GetUserId() : 0,
            PaymentID = GetPaymentId(paymentMethod) ?? 0,
            VoucherID = checkoutInfo.VoucherID,
            OrderType = "online",
            Address = checkoutInfo.Address,
            Note = checkoutInfo.Note,
            OrderDetails = GetOrderDetails(checkoutInfo),
            ShippingFee = checkoutInfo.ShippingFee,
            // GHN Address Fields
            GhnProvinceId = checkoutInfo.GhnProvinceId,
            GhnDistrictId = checkoutInfo.GhnDistrictId,
            GhnWardCode = checkoutInfo.GhnWardCode,
            GhnFullAddress = checkoutInfo.GhnFullAddress
        };

        var createOrderResult = await OrderService.CreateOrderAsync(orderRequest);

        if (!createOrderResult.Success)
        {
            await ToastService.ShowError(createOrderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
            return null;
        }

        CreatedOrderId = createOrderResult.Data;
        return CreatedOrderId;
    }

    /// <summary>
    /// Render PayPal button b·∫±ng JSInterop, callback v·ªÅ Blazor khi thanh to√°n th√†nh c√¥ng ho·∫∑c b·ªã t·ª´ ch·ªëi.
    /// </summary>
    private async Task RenderPayPalButton()
    {
        var amount = GetFinalTotalAmount();
        // Chuy·ªÉn VND sang USD (chia cho t·ª∑ gi√° ~24000)
        var amountInUSD = (amount / 25000m).ToString("F2");
        await JSRuntime.InvokeVoidAsync("eval", $@"
            if (window.paypal) {{
                paypal.Buttons({{
                    createOrder: function(data, actions) {{
                        return actions.order.create({{
                            purchase_units: [{{
                                amount: {{ value: '{amountInUSD}', currency_code: 'USD' }}
                            }}]
                        }});
                    }},
                    onApprove: function(data, actions) {{
                        return actions.order.capture().then(function(details) {{
                            DotNet.invokeMethodAsync('WebUI', 'OnPayPalApproved', JSON.stringify(details));
                        }}).catch(function(err) {{
                            if (err && err.details && err.details[0].issue === 'INSTRUMENT_DECLINED') {{
                                return actions.restart();
                            }}
                        }});
                    }},
                    onError: function(err) {{
                        if (err && err.details && err.details[0].issue === 'INSTRUMENT_DECLINED') {{
                            actions.restart();
                        }}
                    }}
                }}).render('#paypal-button-container');
            }}
        ");
    }

    private async Task HandlePayment()
    {
        if (!AgreeTerms)
        {
            await ToastService.ShowError("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng");
            return;
        }

        var checkoutInfo = CartService.CheckoutInfo;
        if (checkoutInfo == null)
        {
            await ToastService.ShowError("Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng. Vui l√≤ng quay l·∫°i trang checkout.");
            Navigation.NavigateTo("/checkout");
            return;
        }

        IsProcessing = true;
        PaymentStatus = "processing";
        StateHasChanged();

        try
        {
            // 1. T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc
            var orderRequest = new CreateOrderRequest
            {
                UserID = AuthService.IsAuthenticated ? GetUserId() : 0,
                PaymentID = GetPaymentId(SelectedPaymentMethod) ?? 0, // Map payment method to PaymentID
                VoucherID = checkoutInfo.VoucherID, // Apply voucher if selected
                OrderType = "online",
                Address = $"{checkoutInfo.Address}, {checkoutInfo.City}",
                Note = checkoutInfo.Note,
                OrderDetails = GetOrderDetails(checkoutInfo),
                ShippingFee = checkoutInfo.ShippingFee,
                // GHN Address Fields
                GhnProvinceId = checkoutInfo.GhnProvinceId,
                GhnDistrictId = checkoutInfo.GhnDistrictId,
                GhnWardCode = checkoutInfo.GhnWardCode,
                GhnFullAddress = checkoutInfo.GhnFullAddress
            };

            var createOrderResult = await OrderService.CreateOrderAsync(orderRequest);

            if (!createOrderResult.Success)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                await ToastService.ShowError(createOrderResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng");
                StateHasChanged();
                return;
            }

            // L∆∞u OrderID (t·∫°m th·ªùi d√πng timestamp, c·∫ßn l·∫•y t·ª´ API response)
            CreatedOrderId = createOrderResult.Data;

            // 2. X·ª≠ l√Ω thanh to√°n theo ph∆∞∆°ng th·ª©c ƒë√£ ch·ªçn
            if (SelectedPaymentMethod == "vnpay")
            {
                // T·∫°o URL thanh to√°n VNPay
                var paymentResult = await PaymentService.CreateVNPayPaymentUrlAsync(
                    CreatedOrderId.Value,
                    GetFinalTotalAmount(),
                    $"Thanh toan don hang #{CreatedOrderId}"
                );

                if (paymentResult.Success && !string.IsNullOrEmpty(paymentResult.PaymentUrl))
                {
                    // Redirect ƒë·∫øn VNPay
                    await JSRuntime.InvokeVoidAsync("open", paymentResult.PaymentUrl, "_self");
                    return;
                }
                else
                {
                    PaymentStatus = "failed";
                    IsProcessing = false;
                    await ToastService.ShowError(paymentResult.Message ?? "Kh√¥ng th·ªÉ t·∫°o URL thanh to√°n VNPay");
                    StateHasChanged();
                    return;
                }
            }
            else
            {
                // COD ho·∫∑c c√°c ph∆∞∆°ng th·ª©c kh√°c - ch·ªâ c·∫ßn t·∫°o order
                PaymentStatus = "success";
                IsProcessing = false;
                
                // Clear cart after successful order
                await CartService.ClearCartAsync();
                
                await ScrollToTop();
                await ToastService.ShowSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.");
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }

    private int GetUserId()
    {
        return AuthService.GetCurrentUserId() ?? 0;
    }

    private int? GetPaymentId(string paymentMethod)
    {
        // Map payment method to PaymentID
        // TODO: L·∫•y t·ª´ database ho·∫∑c config
        return paymentMethod switch
        {
            "cod" => 1, // COD
            "vnpay" => 2, // VNPay
            "gpay" => 3, // Google Pay
            "paypal" => 4, // PayPal
            _ => null
        };
    }

    private List<OrderDetailRequest> GetOrderDetails(CheckoutInfo checkoutInfo)
    {
        var orderDetails = new List<OrderDetailRequest>();

        if (checkoutInfo.SelectedApiItems != null && checkoutInfo.SelectedApiItems.Any())
        {
            foreach (var item in checkoutInfo.SelectedApiItems)
            {
                orderDetails.Add(new OrderDetailRequest
                {
                    VariantID = item.VariantID,
                    Quantity = item.Quantity
                });
                Console.WriteLine($"[Payment.GetOrderDetails] API Item: VariantID={item.VariantID}, Qty={item.Quantity}");
            }
        }
        else if (checkoutInfo.SelectedLocalItems != null && checkoutInfo.SelectedLocalItems.Any())
        {
            // Guest user: g·ª≠i ProductID + Color + Size ƒë·ªÉ backend t√¨m variant
            foreach (var item in checkoutInfo.SelectedLocalItems)
            {
                var orderDetail = new OrderDetailRequest
                {
                    Quantity = item.Quantity
                };
                
                // N·∫øu c√≥ VariantID (logged in user with local cart)
                if (item.VariantID > 0)
                {
                    orderDetail.VariantID = item.VariantID;
                    Console.WriteLine($"[Payment.GetOrderDetails] Local Item with VariantID: VariantID={item.VariantID}, Qty={item.Quantity}");
                }
                // Guest user: g·ª≠i ProductID + Color + Size
                else
                {
                    orderDetail.ProductID = item.Product.Id;
                    orderDetail.SelectedColor = item.SelectedColor;
                    orderDetail.SelectedSize = item.SelectedSize;
                    Console.WriteLine($"[Payment.GetOrderDetails] Guest user item: ProductID={item.Product.Id}, Color={item.SelectedColor}, Size={item.SelectedSize}, Qty={item.Quantity}");
                }
                
                orderDetails.Add(orderDetail);
            }
        }

        return orderDetails;
    }

    private decimal GetFinalTotalAmount()
    {
        decimal total = SubTotal + ShippingFee - Discount;
        return total;
    }

    private string GetFinalTotal()
    {
        return $"{GetFinalTotalAmount():N0}ƒë";
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        await ToastService.ShowSuccess("ƒê√£ sao ch√©p!");
    }

    private async Task HandleVNPayPayment()
    {
        IsProcessing = true;
        PaymentStatus = "";
        StateHasChanged();
        try
        {
            // T·∫°o order tr∆∞·ªõc khi redirect ƒë·∫øn VNPay
            var orderId = await EnsureOrderCreated("vnpay");
            if (orderId == null || orderId <= 0)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                StateHasChanged();
                return;
            }

            // T·∫°o URL thanh to√°n VNPay
            var response = await PaymentService.CreateVNPayPaymentUrlAsync(orderId.Value, GetFinalTotalAmount(), $"Thanh toan don hang #{orderId}");
            if (response != null && !string.IsNullOrEmpty(response.PaymentUrl))
            {
                // Redirect ƒë·∫øn VNPay
                await JSRuntime.InvokeVoidAsync("open", response.PaymentUrl, "_self");
                return;
            }
            else
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                await ToastService.ShowError(response?.Message ?? "Kh√¥ng th·ªÉ t·∫°o URL thanh to√°n VNPay");
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }

    private async Task HandleCODPayment()
    {
        IsProcessing = true;
        PaymentStatus = "";
        StateHasChanged();
        try
        {
            // T·∫°o order v·ªõi ph∆∞∆°ng th·ª©c COD
            var orderId = await EnsureOrderCreated("cod");
            if (orderId == null || orderId <= 0)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                StateHasChanged();
                return;
            }

            // COD: Order ƒë√£ ƒë∆∞·ª£c t·∫°o, ch·ªâ c·∫ßn hi·ªÉn th·ªã th√†nh c√¥ng
            PaymentStatus = "success";
            IsProcessing = false;
            await ScrollToTop();
            await ToastService.ShowSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.");
            
            // Clear cart after successful order
            await CartService.ClearCartAsync();
            
            // COD: Kh√¥ng c·∫≠p nh·∫≠t payment status, ƒë∆°n h√†ng s·∫Ω ·ªü tr·∫°ng th√°i Pending cho ƒë·∫øn khi giao h√†ng th√†nh c√¥ng
            StateHasChanged();
        }
        catch (Exception ex)
        {
            PaymentStatus = "failed";
            IsProcessing = false;
            await ToastService.ShowError($"L·ªói: {ex.Message}");
            StateHasChanged();
        }
    }


    // Removed unused GPay fields

    private async Task ScrollToTop()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "window.scrollTo({ top: 0, behavior: 'smooth' });");
        }
        catch
        {
            // Silent error handling
        }
    }

    private async Task OnPayClicked()
    {
        if (!AgreeTerms)
        {
            await ToastService.ShowError("Vui l√≤ng ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng");
            return;
        }

        if (SelectedPaymentMethod == "vnpay")
        {
            await HandleVNPayPayment();
        }
        else if (SelectedPaymentMethod == "cod")
        {
            await HandleCODPayment();
        }
        else if (SelectedPaymentMethod == "gpay")
        {
            IsProcessing = true;
            PaymentStatus = "processing";
            StateHasChanged();
            
            // 1. T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc khi g·ªçi Google Pay
            var orderId = await EnsureOrderCreated("gpay");
            if (orderId == null || orderId <= 0)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                StateHasChanged();
                return;
            }

            var amount = GetFinalTotalAmount();
            // L∆∞u orderId v√† amount (VND) v√†o localStorage
            await JSRuntime.InvokeVoidAsync("eval", $"localStorage.setItem('gpay_orderId', '{orderId}')");
            await JSRuntime.InvokeVoidAsync("eval", $"localStorage.setItem('gpay_amount', '{amount:F0}')");
            // 2. G·ªçi Google Pay SDK qua JSInterop ƒë·ªÉ l·∫•y token v√† x·ª≠ l√Ω lu√¥n
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    if (!window.google || !window.payments) {{
                        alert('Google Pay SDK ch∆∞a s·∫µn s√†ng!');
                        return;
                    }}
                    var paymentsClient = new google.payments.api.PaymentsClient({{ environment: 'TEST' }});
                    var baseRequest = {{ apiVersion: 2, apiVersionMinor: 0 }};
                    var allowedCardNetworks = ['VISA', 'MASTERCARD'];
                    var allowedAuthMethods = ['PAN_ONLY', 'CRYPTOGRAM_3DS'];
                    var tokenizationSpec = {{
                        type: 'PAYMENT_GATEWAY',
                        parameters: {{
                            gateway: 'stripe',
                            'stripe:version': '2020-08-27',
                            'stripe:publishableKey': 'pk_test_51SSDaCQvdo5RfVd5QXPLYoKsDjU0UuUo3qgvNBuPptjgUm9f8x43P636jLPVD1wWXPTX4pUYKy3rMawui9EsDSgV00hfGDVemy'
                        }}
                    }};
                    var cardPaymentMethod = {{
                        type: 'CARD',
                        parameters: {{
                            allowedAuthMethods: allowedAuthMethods,
                            allowedCardNetworks: allowedCardNetworks,
                            billingAddressRequired: true,
                            billingAddressParameters: {{ format: 'FULL' }}
                        }},
                        tokenizationSpecification: tokenizationSpec
                    }};
                    var paymentDataRequest = {{
                        apiVersion: 2,
                        apiVersionMinor: 0,
                        allowedPaymentMethods: [cardPaymentMethod],
                        transactionInfo: {{
                            totalPriceStatus: 'FINAL',
                            totalPrice: '{amount}',
                            currencyCode: 'VND',
                            countryCode: 'VN'
                        }},
                        merchantInfo: {{ merchantName: 'Asion Store' }}
                    }};
                    paymentsClient.loadPaymentData(paymentDataRequest)
                        .then(function(paymentData) {{
                            var token = paymentData.paymentMethodData.tokenizationData.token;
                            if (window.DotNet && window.DotNet.invokeMethodAsync) {{
                                window.DotNet.invokeMethodAsync('WebUI', 'ReceiveGPayToken', token);
                            }}
                        }})
                        .catch(function(err) {{
                            alert('‚ùå L·ªói Google Pay: ' + err);
                        }});
                }})();
            ");
        }
        else if (SelectedPaymentMethod == "paypal")
        {
            IsProcessing = true;
            PaymentStatus = "processing";
            StateHasChanged();
            
            // 1. T·∫°o ƒë∆°n h√†ng tr∆∞·ªõc khi hi·ªÉn th·ªã PayPal button
            var orderId = await EnsureOrderCreated("paypal");
            if (orderId == null || orderId <= 0)
            {
                PaymentStatus = "failed";
                IsProcessing = false;
                StateHasChanged();
                return;
            }

            // 2. L∆∞u orderId ƒë·ªÉ callback PayPal s·ª≠ d·ª•ng
            await JSRuntime.InvokeVoidAsync("eval", $"localStorage.setItem('paypal_orderId', '{orderId}')");
            
            // 3. Reset ƒë·ªÉ render PayPal button
            IsProcessing = false;
            PaymentStatus = "";
            PayPalButtonRendered = false;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public static async Task OnPayPalApproved(string detailsJson)
    {
        var serviceProvider = Program.ServiceProvider;
        if (serviceProvider == null) return;

        var paymentService = serviceProvider.GetService(typeof(IPaymentService)) as IPaymentService;
        var nav = serviceProvider.GetService(typeof(NavigationManager)) as NavigationManager;
        var jsRuntime = serviceProvider.GetService(typeof(IJSRuntime)) as IJSRuntime;
        var orderService = serviceProvider.GetService(typeof(IOrderService)) as IOrderService;
        var cartService = serviceProvider.GetService(typeof(CartService)) as CartService;

        if (paymentService == null || nav == null || jsRuntime == null) return;

        string? payPalOrderId = null;
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(detailsJson);
            payPalOrderId = doc.RootElement.GetProperty("id").GetString();
        }
        catch { }

        if (string.IsNullOrEmpty(payPalOrderId)) return;

        // ƒê·ªçc orderId ƒë√£ t·∫°o tr∆∞·ªõc ƒë√≥ t·ª´ localStorage
        var orderIdStr = await jsRuntime.InvokeAsync<string>("eval", "localStorage.getItem('paypal_orderId')");
        int storeOrderId = 0;
        int.TryParse(orderIdStr, out storeOrderId);

        // Capture PayPal payment
        var captureReq = new CaptureReq { OrderId = payPalOrderId };
        var captureResult = await paymentService.CapturePayPal(captureReq);

        if (captureResult != null && captureResult.Success)
        {
            // Clear localStorage
            await jsRuntime.InvokeVoidAsync("eval", "localStorage.removeItem('paypal_orderId')");
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n (1 = ƒë√£ thanh to√°n)
            try { if (storeOrderId > 0 && orderService != null) await orderService.UpdatePaymentStatusAsync(storeOrderId, WebUI.Models.PaymentStatus.Paid); } catch { }
            
            // Clear cart after successful payment
            if (cartService != null)
            {
                await cartService.ClearCartAsync();
            }
            
            nav.NavigateTo($"/payment-success?transactionId={payPalOrderId}&orderId={storeOrderId}");
        }
    }

    // Khi nh·∫≠n token t·ª´ JS, th·ª±c hi·ªán thanh to√°n lu√¥n
    [JSInvokable]
    public static async Task ReceiveGPayToken(string token)
    {
        var serviceProvider = Program.ServiceProvider;
        if (serviceProvider == null)
        {
            return;
        }
        var nav = serviceProvider.GetService(typeof(NavigationManager)) as NavigationManager;
        var paymentService = serviceProvider.GetService(typeof(IPaymentService)) as IPaymentService;
        var orderService = serviceProvider.GetService(typeof(IOrderService)) as IOrderService;
        if (nav == null || paymentService == null)
        {
            return;
        }
        var navSafe = nav!;
        var paymentServiceSafe = paymentService!;
        // ƒê·ªçc amount v√† orderId t·ª´ localStorage qua JSInterop
        var jsRuntime = serviceProvider.GetService(typeof(IJSRuntime)) as IJSRuntime;
        if (jsRuntime == null)
        {
            return;
        }
        // ƒê·ªçc gi√° tr·ªã t·ª´ localStorage
        var amountStr = await jsRuntime.InvokeAsync<string>("eval", "localStorage.getItem('gpay_amount')");
        var orderIdStr = await jsRuntime.InvokeAsync<string>("eval", "localStorage.getItem('gpay_orderId')");
        long amount = 0;
        int orderId = 0;
        long.TryParse(amountStr, out amount);
        int.TryParse(orderIdStr, out orderId);
        // Stripe expects amount in VND (not cents)
        if (amount < 1000 || amount > 99999999)
        {
            // Handle error: amount must be >= 1000 VND and <= 99,999,999 VND
            return;
        }
        var gpayRequest = new PaymentGPayRequest
        {
            Token = token,
            Amount = amount,
            Currency = "vnd",
            Description = $"Thanh to√°n ƒë∆°n h√†ng #{orderId} qua Google Pay"
        };
        var gpayResult = await paymentServiceSafe.CreateGPayPaymentAsync(gpayRequest);
        if (gpayResult != null && gpayResult.Success && !string.IsNullOrEmpty(gpayResult.TransactionId))
        {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n (1 = ƒë√£ thanh to√°n)
            try 
            { 
                if (orderId > 0 && orderService != null) 
                {
                    var updateResult = await orderService.UpdatePaymentStatusAsync(orderId, WebUI.Models.PaymentStatus.Paid);
                    if (!updateResult.Success)
                    {
                        Console.WriteLine($"Failed to update payment status: {updateResult.Message}");
                    }
                }
            } 
            catch (Exception ex) 
            { 
                Console.WriteLine($"Error updating payment status: {ex.Message}");
            }
            navSafe.NavigateTo($"/payment-success?transactionId={gpayResult.TransactionId}&amount={gpayRequest.Amount}&orderId={orderId}");
        }
    }
}

