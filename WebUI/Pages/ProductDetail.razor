@page "/product/{ProductId:int}"
@using WebUI.Models
@using WebUI.Services
@using WebUI.Services.Interfaces
@using WebUI.Components
@inject IJSRuntime JSRuntime
@inject CartService CartService
@inject IProductService ProductService
@inject IToastService ToastService
@inject RecentlyViewedService RecentlyViewedService

<PageTitle>@(CurrentProduct?.Name ?? "Product") - Asion</PageTitle>

<div class="product-detail-container">
    @if (CurrentProduct != null)
    {
        <!-- Breadcrumb -->
        <nav class="breadcrumb-nav">
            <div class="container">
                <ol class="breadcrumb">
                    <li><a href="/">Home</a></li>
                    <li><a href="/products">Products</a></li>
                    <li class="active">@CurrentProduct.Name</li>
                </ol>
            </div>
        </nav>

        <!-- Main Product Section -->
        <div class="product-main-section">
            <div class="container">
                <div class="product-layout">
                    <!-- Left: Product Images -->
                    <div class="product-images-section">
                        <ProductImageGallery Product="CurrentProduct" 
                                           SelectedColor="@SelectedColor"
                                           SelectedSize="@SelectedSize" />
                    </div>

                    <!-- Right: Product Details -->
                    <div class="product-details-section">
                        <ProductDetails Product="CurrentProduct" 
                                      OnQuantityChanged="OnQuantityChanged"
                                      OnAddToCart="OnAddToCartWithOptions"
                                      OnBuyNow="OnBuyNow"
                                      OnSizeChanged="OnSizeChanged"
                                      OnColorChanged="OnColorChanged"
                                      InitialQuantity="Quantity"
                                      InitialSize="SelectedSize"
                                      InitialColor="SelectedColor" />
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Information Tabs -->
        <div class="product-tabs-section">
            <div class="container">
                <ProductTabs Product="CurrentProduct" />
            </div>
        </div>

        <!-- Related Products -->
        <div class="related-products-section">
            <div class="container">
                <RelatedProducts CurrentProduct="CurrentProduct" 
                               Products="RelatedProductsList" />
            </div>
        </div>

        <!-- Recently Viewed Products -->
        @if (RecentlyViewedProducts.Any())
        {
            <div class="recently-viewed-section">
                <div class="container">
                    <div class="section-header">
                        <h2 class="section-title">Đã xem gần đây</h2>
                        <p class="section-subtitle">Các sản phẩm bạn đã xem</p>
                    </div>
                    <div class="products-grid">
                        @foreach (var product in RecentlyViewedProducts.Take(6))
                        {
                            <ProductCard Product="product" />
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Mobile Sticky Actions -->
        <div class="mobile-sticky-actions">
            <div class="mobile-actions-content">
                <div class="mobile-price">
                    <span class="current-price">@GetCurrentPriceFormatted()</span>
                    @if (!string.IsNullOrEmpty(CurrentProduct?.OldPriceFormatted))
                    {
                        <span class="old-price">@CurrentProduct.OldPriceFormatted</span>
                    }
                </div>
                <div class="mobile-buttons">
                    <button class="btn-add-cart mobile" @onclick="OnAddToCartWithOptions">
                        <i class="fas fa-cart-plus"></i>
                        Add to Cart
                    </button>
                    <button class="btn-buy-now mobile" @onclick="OnBuyNow">
                        Buy Now
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Product Not Found -->
        <div class="product-not-found">
            <div class="container">
                <div class="not-found-content">
                    <i class="fas fa-search"></i>
                    <h2>Product Not Found</h2>
                    <p>The product you're looking for doesn't exist or has been removed.</p>
                    <a href="/" class="btn-back-home">Back to Home</a>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int ProductId { get; set; }
    
    private Product? CurrentProduct { get; set; }
    private List<Product> RelatedProductsList { get; set; } = new();
    private List<Product> RecentlyViewedProducts { get; set; } = new();
    private int Quantity { get; set; } = 1;
    private string SelectedSize { get; set; } = "";
    private string SelectedColor { get; set; } = "";

    protected override async Task OnParametersSetAsync()
    {
        await LoadProduct();
    }

    private async Task LoadProduct()
    {
        CurrentProduct = await ProductService.GetProductByIdAsync(ProductId);
        
        if (CurrentProduct != null && CurrentProduct.Id > 0)
        {
            // Save to recently viewed
            await RecentlyViewedService.AddProductAsync(CurrentProduct);
            
            // Load related products
            RelatedProductsList = await ProductService.GetRelatedProductsAsync(CurrentProduct.Id, 6);
            
            // Load recently viewed (excluding current product)
            var recentlyViewed = await RecentlyViewedService.GetRecentlyViewedAsync();
            RecentlyViewedProducts = recentlyViewed.Where(p => p.Id != ProductId).ToList();
        }
    }

    private void OnQuantityChanged(int newQuantity)
    {
        Quantity = newQuantity;
        StateHasChanged();
    }

    private async Task OnAddToCart()
    {
        if (CurrentProduct != null)
        {
            // Add to cart with quantity
            CartService.AddItem(CurrentProduct, Quantity);
            await ShowToast("success", "Added to Cart!", $"{CurrentProduct.Name} (x{Quantity}) has been added to your cart.");
        }
    }

    private async Task OnAddToCartWithOptions()
    {
        if (CurrentProduct != null)
        {
            // Add to cart - sẽ tự động chọn local hoặc API dựa vào trạng thái login
            var response = await CartService.AddToCartAsync(
                CurrentProduct, 
                Quantity, 
                SelectedSize, 
                SelectedColor
            );

            if (response.Success)
            {
                await ToastService.ShowSuccess("Đã thêm vào giỏ hàng!");
            }
            else
            {
                await ToastService.ShowError(response.Message);
            }
        }
    }

    private async Task OnBuyNow()
    {
        if (CurrentProduct != null)
        {
            // Buy now logic - redirect to checkout
            await ShowToast("info", "Redirecting...", "Taking you to checkout page.");
            
            // Simulate navigation delay
            await Task.Delay(1500);
            // Navigation.NavigateTo("/checkout");
        }
    }

    private void OnSizeChanged(string newSize)
    {
        SelectedSize = newSize;
        StateHasChanged();
    }

    private void OnColorChanged(string newColor)
    {
        SelectedColor = newColor;
        StateHasChanged();
    }

    private decimal GetCurrentPrice()
    {
        if (CurrentProduct == null) return 0;

        // If both color and size are selected, get the specific variant price
        if (!string.IsNullOrEmpty(SelectedColor) && !string.IsNullOrEmpty(SelectedSize))
        {
            var colorInfo = CurrentProduct.Colors?.FirstOrDefault(c => c.HexColor.Equals(SelectedColor, StringComparison.OrdinalIgnoreCase));
            if (colorInfo?.SizePrice != null && colorInfo.SizePrice.TryGetValue(SelectedSize, out decimal variantPrice))
            {
                return variantPrice;
            }
        }
        
        // Fall back to the product's default price (minimum price across all variants)
        return CurrentProduct.Price;
    }

    private string GetCurrentPriceFormatted()
    {
        return $"{GetCurrentPrice():N0}đ";
    }

    private async Task ShowToast(string type, string title, string message)
    {
        var fullMessage = $"{title}: {message}";
        switch (type.ToLower())
        {
            case "success":
                await ToastService.ShowSuccess(fullMessage);
                break;
            case "error":
                await ToastService.ShowError(fullMessage);
                break;
            case "warning":
                await ToastService.ShowWarning(fullMessage);
                break;
            default:
                await ToastService.ShowInfo(fullMessage);
                break;
        }
    }
}